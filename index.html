<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CareOS AI">
<meta name="theme-color" content="#0B1A2B">
<title>CareOS AI Demo</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #1B7A9E;
  --primary-light: #2A9BC2;
  --primary-soft: #E4F3F9;
  --primary-glow: rgba(27,122,158,0.15);
  --accent: #E56B3E;
  --accent-soft: #FFF1EC;
  --success: #1DA362;
  --success-soft: #E3F6EC;
  --warning: #C88B0A;
  --warning-soft: #FFF7E0;
  --danger: #C0392B;
  --danger-soft: #FCE8E6;
  --bg: #F5F7FA;
  --card: #FFFFFF;
  --card-hover: #FAFBFC;
  --border: #E0E5EC;
  --border-light: #EEF1F5;
  --text: #0F1D2F;
  --text-sec: #4A5B72;
  --text-muted: #8697AB;
  --shadow-sm: 0 1px 3px rgba(15,29,47,0.06), 0 1px 2px rgba(15,29,47,0.04);
  --shadow-md: 0 4px 12px rgba(15,29,47,0.08), 0 2px 4px rgba(15,29,47,0.04);
  --shadow-lg: 0 12px 40px rgba(15,29,47,0.12), 0 4px 12px rgba(15,29,47,0.06);
  --radius: 14px;
  --radius-sm: 10px;
  --radius-lg: 18px;
  --radius-xl: 24px;
  --radius-full: 999px;
  --font: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { 
  font-family: var(--font); background: var(--bg); color: var(--text); 
  min-height: 100vh; min-height: 100dvh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ‚îÄ SCREEN MANAGEMENT ‚îÄ‚îÄ‚îÄ */
.screen { display: none; min-height: 100vh; min-height: 100dvh; flex-direction: column; }
.screen.active { display: flex; }

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar {
  padding: calc(var(--safe-top) + 12px) 20px 14px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.topbar-row { display: flex; align-items: center; gap: 12px; }
.topbar-back {
  width: 38px; height: 38px; border-radius: var(--radius-sm); background: var(--bg);
  display: flex; align-items: center; justify-content: center; border: none; cursor: pointer;
  color: var(--text); font-size: 18px;
}
.topbar-title { font-size: 19px; font-weight: 700; letter-spacing: -0.3px; flex: 1; }
.topbar-subtitle { font-size: 12px; color: var(--text-sec); margin-top: 2px; }

/* ‚îÄ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ‚îÄ */
.home-header {
  padding: calc(var(--safe-top) + 16px) 20px 16px;
  background: linear-gradient(135deg, #0B1A2B 0%, #132D4A 100%);
  color: white;
}
.home-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.home-logo-icon {
  width: 40px; height: 40px; border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex; align-items: center; justify-content: center; font-size: 18px;
}
.home-logo-text { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
.home-logo-badge {
  font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.15);
  padding: 3px 8px; border-radius: var(--radius-full); margin-left: auto;
}
.home-stats {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;
}
.home-stat {
  background: rgba(255,255,255,0.08); border-radius: var(--radius-sm);
  padding: 10px 12px; text-align: center; border: 1px solid rgba(255,255,255,0.06);
}
.home-stat-value { font-size: 22px; font-weight: 800; }
.home-stat-label { font-size: 10px; opacity: 0.6; margin-top: 2px; font-weight: 500; }

/* ‚îÄ‚îÄ‚îÄ MODE INDICATOR ‚îÄ‚îÄ‚îÄ */
.mode-bar {
  margin: 16px 20px 0; padding: 10px 14px; border-radius: var(--radius);
  display: flex; align-items: center; gap: 10px;
  font-size: 12px; font-weight: 600;
}
.mode-bar.live { background: var(--success-soft); color: var(--success); border: 1px solid rgba(29,163,98,0.2); }
.mode-bar.demo { background: var(--warning-soft); color: var(--warning); border: 1px solid rgba(200,139,10,0.2); }
.mode-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.mode-bar.live .mode-dot { background: var(--success); animation: pulse 2s infinite; }
.mode-bar.demo .mode-dot { background: var(--warning); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* ‚îÄ‚îÄ‚îÄ RESIDENT SELECTOR ‚îÄ‚îÄ‚îÄ */
.resident-section { padding: 16px 20px 8px; }
.section-label {
  font-size: 11px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;
}
.resident-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
.resident-chips::-webkit-scrollbar { display: none; }
.resident-chip {
  padding: 8px 16px; border-radius: var(--radius-full); font-size: 13px; font-weight: 600;
  white-space: nowrap; cursor: pointer; border: 1.5px solid var(--border);
  background: var(--card); color: var(--text); transition: all 0.15s;
}
.resident-chip.active {
  background: var(--primary); color: white; border-color: var(--primary);
}

/* ‚îÄ‚îÄ‚îÄ CAPTURE AREA ‚îÄ‚îÄ‚îÄ */
.capture-section { padding: 8px 20px 20px; flex: 1; display: flex; flex-direction: column; gap: 12px; }
.capture-main {
  flex: 1; min-height: 200px; border: 2.5px dashed rgba(27,122,158,0.35);
  border-radius: var(--radius-xl); background: linear-gradient(145deg, var(--primary-soft), #EDF5F8);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 14px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
}
.capture-main:active { transform: scale(0.98); }
.capture-icon {
  width: 72px; height: 72px; border-radius: 22px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 8px 28px rgba(27,122,158,0.3); font-size: 30px; color: white;
}
.capture-text { font-size: 17px; font-weight: 700; color: var(--primary); }
.capture-subtext { font-size: 13px; color: var(--text-sec); }

.capture-upload {
  padding: 14px; border-radius: var(--radius); background: var(--card);
  border: 1.5px solid var(--border); display: flex; align-items: center;
  justify-content: center; gap: 10px; cursor: pointer; font-size: 14px;
  font-weight: 600; color: var(--text-sec); transition: all 0.15s;
}
.capture-upload:active { background: var(--bg); }

.info-box {
  padding: 12px 14px; border-radius: var(--radius); display: flex;
  align-items: flex-start; gap: 10px; font-size: 12px; line-height: 1.5;
}
.info-box.accent { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(229,107,62,0.2); }
.info-box.success { background: var(--success-soft); color: var(--success); border: 1px solid rgba(29,163,98,0.2); }
.info-box.warning { background: var(--warning-soft); color: var(--warning); border: 1px solid rgba(200,139,10,0.2); }
.info-box.danger { background: var(--danger-soft); color: var(--danger); border: 1px solid rgba(192,57,43,0.2); }
.info-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

/* ‚îÄ‚îÄ‚îÄ BOTTOM ACTIONS ‚îÄ‚îÄ‚îÄ */
.bottom-actions { padding: 0 20px 20px; display: flex; flex-direction: column; gap: 10px; }
.bottom-actions { padding-bottom: calc(var(--safe-bottom) + 20px); }

.btn-link {
  padding: 12px; border-radius: var(--radius); background: var(--primary-soft);
  border: 1px solid rgba(27,122,158,0.15); text-align: center; cursor: pointer;
  font-size: 13px; font-weight: 600; color: var(--primary);
}
.btn-row { display: flex; gap: 10px; }
.btn-row > * { flex: 1; }
.btn-icon-label {
  padding: 12px; border-radius: var(--radius); background: var(--card);
  border: 1.5px solid var(--border); display: flex; flex-direction: column;
  align-items: center; gap: 6px; cursor: pointer; font-size: 12px;
  font-weight: 600; color: var(--text-sec);
}
.btn-icon-label .bi { font-size: 20px; }

/* ‚îÄ‚îÄ‚îÄ PROCESSING SCREEN ‚îÄ‚îÄ‚îÄ */
.processing-center {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 40px 32px; text-align: center;
}
.processing-preview {
  width: 180px; height: 130px; border-radius: var(--radius); overflow: hidden;
  border: 2px solid var(--border); box-shadow: var(--shadow-md); margin-bottom: 28px;
}
.processing-preview img { width: 100%; height: 100%; object-fit: cover; }
.spinner {
  width: 52px; height: 52px; border: 4px solid var(--border-light);
  border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
  margin-bottom: 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.processing-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
.processing-step { font-size: 14px; color: var(--text-sec); }
.processing-dots { display: flex; gap: 6px; margin-top: 16px; }
.processing-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--primary);
  animation: dotPulse 1.4s ease-in-out infinite;
}
.processing-dot:nth-child(2) { animation-delay: 0.2s; }
.processing-dot:nth-child(3) { animation-delay: 0.4s; }
.processing-dot:nth-child(4) { animation-delay: 0.6s; }
@keyframes dotPulse { 0%,100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }

/* ‚îÄ‚îÄ‚îÄ RESULTS SCREEN ‚îÄ‚îÄ‚îÄ */
.results-scroll { flex: 1; overflow-y: auto; padding: 12px 16px 100px; }
.result-banner {
  padding: 10px 14px; border-radius: var(--radius); display: flex;
  align-items: center; gap: 10px; margin-bottom: 12px;
}
.result-banner.success { background: var(--success-soft); border: 1px solid rgba(29,163,98,0.2); }
.result-banner .rb-icon { font-size: 18px; }
.result-banner .rb-text { font-size: 13px; font-weight: 700; color: var(--success); }
.result-banner .rb-sub { font-size: 11px; color: var(--success); opacity: 0.8; }

.result-preview {
  height: 72px; border-radius: var(--radius-sm); overflow: hidden;
  border: 1px solid var(--border); margin-bottom: 12px;
}
.result-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }

.result-field {
  padding: 13px 14px; margin-bottom: 8px; background: var(--card);
  border-radius: var(--radius); border: 1.5px solid var(--border);
  cursor: pointer; transition: all 0.15s; box-shadow: var(--shadow-sm);
}
.result-field:active { transform: scale(0.99); }
.result-field.edited { border-color: var(--primary); }
.result-field-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.result-field-label {
  font-size: 10px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.edited-tag {
  font-size: 9px; font-weight: 700; color: var(--primary);
  background: var(--primary-soft); padding: 2px 7px; border-radius: var(--radius-full);
  margin-left: 6px;
}
.confidence-badge {
  font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: var(--radius-full);
}
.conf-high { color: var(--success); background: var(--success-soft); }
.conf-mid { color: var(--warning); background: var(--warning-soft); }
.conf-low { color: var(--danger); background: var(--danger-soft); }
.result-field-value { font-size: 15px; font-weight: 600; line-height: 1.4; }
.low-conf-warning {
  margin-top: 6px; font-size: 11px; color: var(--warning);
  display: flex; align-items: center; gap: 4px;
}

/* Edit mode */
.edit-row { display: flex; gap: 8px; margin-top: 8px; }
.edit-input {
  flex: 1; padding: 9px 12px; border-radius: var(--radius-sm);
  border: 2px solid var(--primary); font-size: 14px; font-weight: 600;
  color: var(--text); font-family: var(--font); outline: none;
}
.edit-save {
  padding: 9px 18px; border-radius: var(--radius-sm); background: var(--primary);
  color: white; font-size: 13px; font-weight: 700; border: none; cursor: pointer;
  font-family: var(--font);
}
.edit-cancel {
  padding: 9px 14px; border-radius: var(--radius-sm); background: var(--bg);
  color: var(--text-sec); font-size: 13px; font-weight: 600; border: 1px solid var(--border);
  cursor: pointer; font-family: var(--font);
}

/* Fixed bottom confirm */
.results-bottom {
  position: fixed; bottom: 0; left: 0; right: 0; max-width: 100%;
  padding: 12px 16px calc(var(--safe-bottom) + 16px);
  background: linear-gradient(transparent, var(--bg) 20%);
}
.confirm-stats { font-size: 11px; color: var(--text-muted); text-align: center; margin-bottom: 8px; }
.btn-confirm {
  width: 100%; padding: 16px; border-radius: var(--radius-lg); border: none;
  font-size: 16px; font-weight: 700; cursor: pointer; font-family: var(--font);
  background: linear-gradient(135deg, var(--success), var(--primary));
  color: white; box-shadow: 0 4px 20px rgba(29,163,98,0.35);
  transition: all 0.2s;
}
.btn-confirm:active { transform: scale(0.98); }
.pending-note { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 6px; }

/* ‚îÄ‚îÄ‚îÄ CONFIRMED SCREEN ‚îÄ‚îÄ‚îÄ */
.confirmed-center {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 40px 32px;
}
.confirmed-check {
  width: 88px; height: 88px; border-radius: 50%; background: var(--success-soft);
  display: flex; align-items: center; justify-content: center;
  font-size: 44px; margin-bottom: 20px;
  animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes scaleIn { from { transform: scale(0); } to { transform: scale(1); } }
.confirmed-title { font-size: 24px; font-weight: 800; margin-bottom: 6px; letter-spacing: -0.5px; }
.confirmed-med { font-size: 15px; color: var(--text-sec); margin-bottom: 4px; }
.confirmed-resident { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
.confirmed-time-badge {
  padding: 6px 16px; border-radius: var(--radius-full);
  background: var(--success-soft); border: 1px solid rgba(29,163,98,0.2);
  font-size: 12px; font-weight: 600; color: var(--success); margin-bottom: 28px;
}
.confirmed-status {
  padding: 6px 16px; border-radius: var(--radius-full);
  background: var(--warning-soft); border: 1px solid rgba(200,139,10,0.2);
  font-size: 12px; font-weight: 600; color: var(--warning); margin-bottom: 32px;
}
.btn-primary {
  width: 100%; padding: 15px; border-radius: var(--radius-lg); border: none;
  font-size: 15px; font-weight: 700; cursor: pointer; font-family: var(--font);
  background: var(--primary); color: white; margin-bottom: 10px;
}
.btn-secondary {
  width: 100%; padding: 14px; border-radius: var(--radius); border: 1.5px solid var(--border);
  font-size: 14px; font-weight: 600; cursor: pointer; font-family: var(--font);
  background: var(--card); color: var(--text);
}

/* ‚îÄ‚îÄ‚îÄ HISTORY SCREEN ‚îÄ‚îÄ‚îÄ */
.history-scroll { flex: 1; overflow-y: auto; padding: 12px 16px; }
.history-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
.history-empty-icon { font-size: 40px; margin-bottom: 12px; }
.history-card {
  padding: 14px; margin-bottom: 10px; background: var(--card);
  border-radius: var(--radius); border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.hc-top { display: flex; justify-content: space-between; align-items: flex-start; }
.hc-med { font-size: 15px; font-weight: 700; }
.hc-dose { font-size: 12px; color: var(--text-sec); margin-top: 2px; }
.hc-badge {
  font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: var(--radius-full);
}
.hc-live { color: var(--success); background: var(--success-soft); }
.hc-demo { color: var(--warning); background: var(--warning-soft); }
.hc-meta { display: flex; gap: 14px; margin-top: 10px; font-size: 11px; color: var(--text-muted); }
.hc-accuracy {
  margin-top: 8px; display: flex; align-items: center; gap: 8px;
}
.hc-accuracy-bar { flex: 1; height: 4px; background: var(--border-light); border-radius: 2px; overflow: hidden; }
.hc-accuracy-fill { height: 100%; border-radius: 2px; }
.hc-accuracy-text { font-size: 11px; font-weight: 700; min-width: 32px; text-align: right; }

/* ‚îÄ‚îÄ‚îÄ SETTINGS SCREEN ‚îÄ‚îÄ‚îÄ */
.settings-scroll { flex: 1; overflow-y: auto; padding: 16px; }
.settings-card {
  padding: 16px; background: var(--card); border-radius: var(--radius);
  border: 1px solid var(--border); margin-bottom: 12px; box-shadow: var(--shadow-sm);
}
.sc-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
.sc-desc { font-size: 12px; color: var(--text-sec); }
.toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.toggle {
  width: 52px; height: 28px; border-radius: 14px; padding: 2px;
  cursor: pointer; transition: all 0.2s; border: none;
}
.toggle.on { background: var(--success); }
.toggle.off { background: var(--border); }
.toggle-knob {
  width: 24px; height: 24px; border-radius: 12px; background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s;
}
.toggle.on .toggle-knob { transform: translateX(24px); }
.api-input-group { margin-top: 12px; }
.api-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.api-input {
  width: 100%; padding: 11px 14px; border-radius: var(--radius-sm);
  border: 1.5px solid var(--border); font-size: 13px; font-family: monospace;
  color: var(--text); outline: none; background: var(--bg);
}
.api-input:focus { border-color: var(--primary); }
.api-hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; line-height: 1.5; }
.api-status {
  margin-top: 10px; padding: 6px 12px; border-radius: var(--radius-full);
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 600;
}
.api-status.ready { background: var(--success-soft); color: var(--success); }

/* ‚îÄ‚îÄ‚îÄ GUIDE SCREEN ‚îÄ‚îÄ‚îÄ */
.guide-scroll { flex: 1; overflow-y: auto; padding: 16px; }
.guide-step {
  padding: 14px 16px; margin-bottom: 10px; background: var(--card);
  border-radius: var(--radius); border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.gs-row { display: flex; align-items: flex-start; gap: 12px; }
.gs-num {
  width: 28px; height: 28px; border-radius: 50%; background: var(--primary);
  color: white; display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; flex-shrink: 0;
}
.gs-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
.gs-content { font-size: 12.5px; color: var(--text-sec); line-height: 1.6; }

.validation-box {
  padding: 14px; margin-top: 8px; border-radius: var(--radius);
  background: var(--success-soft); border: 1px solid rgba(29,163,98,0.2);
}
.vb-title { font-size: 13px; font-weight: 700; color: var(--success); margin-bottom: 4px; }
.vb-content { font-size: 12px; color: var(--success); line-height: 1.6; }

/* ‚îÄ‚îÄ‚îÄ UTILITY ‚îÄ‚îÄ‚îÄ */
input[type="file"] { display: none; }
.hidden { display: none !important; }

.med-divider {
  margin: 14px 0 10px;
  padding-top: 14px;
  border-top: 2px dashed var(--border);
  font-size: 11px;
  font-weight: 700;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.result-field.warning-field {
  background: #FFFAF5;
  border-color: rgba(200, 139, 10, 0.3);
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-home" class="screen active">
  <div class="home-header">
    <div class="home-logo">
      <div class="home-logo-icon">üíä</div>
      <div class="home-logo-text">CareOS AI</div>
      <div class="home-logo-badge">v0.1 Demo</div>
    </div>
    <div style="font-size:13px;opacity:0.7;margin-bottom:4px;">AI Doctor Order Reader</div>
    <div style="font-size:11px;opacity:0.5;">Photograph ‚Üí AI Extracts ‚Üí You Confirm</div>
    <div class="home-stats">
      <div class="home-stat">
        <div class="home-stat-value" id="stat-processed">0</div>
        <div class="home-stat-label">Processed</div>
      </div>
      <div class="home-stat">
        <div class="home-stat-value" id="stat-accuracy">‚Äî</div>
        <div class="home-stat-label">Avg Accuracy</div>
      </div>
      <div class="home-stat">
        <div class="home-stat-value" id="stat-edited">0</div>
        <div class="home-stat-label">Fields Edited</div>
      </div>
    </div>
  </div>

  <!-- Mode indicator -->
  <div id="mode-indicator" class="mode-bar demo">
    <div class="mode-dot"></div>
    <span id="mode-text">Setup needed ‚Äî add API key in Settings</span>
  </div>

  <!-- Resident selector -->
  <div class="resident-section">
    <div class="section-label">Processing order for</div>
    <div class="resident-chips" id="resident-chips"></div>
  </div>

  <!-- Capture -->
  <div class="capture-section">
    <div class="capture-main" id="btn-camera">
      <div class="capture-icon">üì∏</div>
      <div class="capture-text">Take Photo of Doctor's Order</div>
      <div class="capture-subtext">Point your camera at the document</div>
    </div>

    <div class="capture-upload" id="btn-upload">
      <span>üìÅ</span>
      <span>Upload from Files</span>
    </div>

    <div class="info-box accent">
      <span class="info-icon">‚ÑπÔ∏è</span>
      <div>
        <strong>How it works:</strong> AI reads the photo and extracts medication name, dosage, route, frequency, prescriber, and instructions. You always review and confirm before anything is added.
      </div>
    </div>
  </div>

  <!-- Bottom -->
  <div class="bottom-actions">
    <div class="btn-row">
      <div class="btn-icon-label" onclick="showScreen('history')">
        <span class="bi">üïê</span>
        <span>History</span>
      </div>
      <div class="btn-icon-label" onclick="showScreen('settings')">
        <span class="bi">‚öôÔ∏è</span>
        <span>Settings</span>
      </div>
      <div class="btn-icon-label" onclick="showScreen('guide')">
        <span class="bi">üìã</span>
        <span>Test Guide</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROCESSING SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-processing" class="screen">
  <div class="processing-center">
    <div class="processing-preview" id="processing-preview"></div>
    <div class="spinner"></div>
    <div class="processing-title">Reading Order...</div>
    <div class="processing-step" id="processing-step">Analyzing image...</div>
    <div class="processing-dots">
      <div class="processing-dot"></div>
      <div class="processing-dot"></div>
      <div class="processing-dot"></div>
      <div class="processing-dot"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESULTS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-results" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="showScreen('home')">‚Üê</button>
      <div>
        <div class="topbar-title">Review Extraction</div>
        <div class="topbar-subtitle" id="results-subtitle"></div>
      </div>
    </div>
  </div>
  <div class="results-scroll" id="results-scroll"></div>
  <div class="results-bottom">
    <div class="confirm-stats" id="confirm-stats"></div>
    <button class="btn-confirm" id="btn-confirm-order" onclick="confirmOrder()">‚úì Confirm & Add to Pending</button>
    <div class="pending-note">Medication stays PENDING until physical receipt is confirmed</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIRMED SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-confirmed" class="screen">
  <div class="confirmed-center">
    <div class="confirmed-check">‚úì</div>
    <div class="confirmed-title">Order Confirmed</div>
    <div class="confirmed-med" id="confirmed-med"></div>
    <div class="confirmed-resident" id="confirmed-resident"></div>
    <div class="confirmed-time-badge" id="confirmed-time"></div>
    <div class="confirmed-status">Status: PENDING ‚Äî awaiting physical receipt</div>
    <button class="btn-primary" onclick="resetAndHome()">Process Another Order</button>
    <button class="btn-secondary" onclick="showScreen('history')">View History (<span id="confirmed-count">0</span>)</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-history" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="showScreen('home')">‚Üê</button>
      <div class="topbar-title">Processing History</div>
    </div>
  </div>
  <div class="history-scroll" id="history-scroll"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-settings" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="showScreen('home')">‚Üê</button>
      <div class="topbar-title">Settings</div>
    </div>
  </div>
  <div class="settings-scroll">
    <div class="settings-card">
      <div class="toggle-row">
        <div>
          <div class="sc-title">Use Real Claude API</div>
          <div class="sc-desc">Connect to Anthropic's Claude Vision</div>
        </div>
        <button class="toggle off" id="toggle-api" onclick="toggleAPI()">
          <div class="toggle-knob"></div>
        </button>
      </div>
      <div id="api-config" class="hidden">
        <div class="api-input-group">
          <div class="api-label">Anthropic API Key</div>
          <input type="password" class="api-input" id="api-key-input" placeholder="sk-ant-api03-..." oninput="onApiKeyInput()">
          <div class="api-hint">Get your key at <strong>console.anthropic.com</strong>. Your key stays in your browser only ‚Äî never sent anywhere except Anthropic's API.</div>
          <div class="api-status ready hidden" id="api-status">
            <div class="mode-dot" style="background:var(--success);width:7px;height:7px;"></div>
            API key set ‚Äî ready for live testing
          </div>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="sc-title">Model Selection</div>
      <div class="sc-desc" style="margin-bottom:10px;">Choose which Claude model to use</div>
      <select id="model-select" style="width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1.5px solid var(--border);font-family:var(--font);font-size:13px;font-weight:600;background:var(--bg);color:var(--text);">
        <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Fastest/Cheapest)</option>
      </select>
    </div>

    <div class="settings-card">
      <div class="sc-title">Estimated API Cost</div>
      <div class="sc-desc" style="line-height:1.6;">
        Each doctor order photo costs approximately <strong>$0.01‚Äì$0.03</strong> to process.
        A facility processing 10 orders/month costs roughly <strong>$0.10‚Äì$0.30/month</strong>.
      </div>
    </div>

    <div class="settings-card">
      <div class="sc-title">Clear All Data</div>
      <div class="sc-desc" style="margin-bottom:10px;">Remove all history and settings from this device</div>
      <button class="btn-secondary" onclick="clearAllData()" style="width:100%;color:var(--danger);border-color:var(--danger);font-size:13px;">
        üóëÔ∏è Clear All Data
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GUIDE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-guide" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="showScreen('home')">‚Üê</button>
      <div class="topbar-title">Testing Guide</div>
    </div>
  </div>
  <div class="guide-scroll">
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">1</div>
        <div>
          <div class="gs-title">Get Sample Doctor Orders</div>
          <div class="gs-content">Search Google Images for "physician medication order form" or "doctor prescription order." You can also write fake orders by hand with messy handwriting ‚Äî that's actually the best test. Or ask an AFH operator for blank order forms.</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">2</div>
        <div>
          <div class="gs-title">Set Up Your API Key</div>
          <div class="gs-content">Go to console.anthropic.com ‚Üí Create account ‚Üí Add credit card ($5 minimum) ‚Üí API Keys ‚Üí Create new key ‚Üí Copy it. Then paste it in Settings.</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">3</div>
        <div>
          <div class="gs-title">Run 20‚Äì30 Test Orders</div>
          <div class="gs-content">Test a variety: printed orders, handwritten, faxed copies, multiple medications, PRN orders, discontinuations. For each one, check: Did it get the medication name right? The dosage? Did you need to edit fields?</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">4</div>
        <div>
          <div class="gs-title">Track Your Results</div>
          <div class="gs-content">The History screen tracks every order with accuracy scores. After 20+ tests, check your overall accuracy. Also check your Anthropic dashboard ‚Äî total cost should be well under $1.</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">5</div>
        <div>
          <div class="gs-title">Evaluate Results</div>
          <div class="gs-content">Count how many orders had ALL fields correct without editing. Calculate: (correct orders √∑ total orders) √ó 100 = your accuracy rate.</div>
        </div>
      </div>
    </div>
    <div class="validation-box">
      <div class="vb-title">‚úì What "Validated" Looks Like</div>
      <div class="vb-content">90%+ accuracy on printed orders, 80%+ on handwritten, processing time under 15 seconds, and total test cost under $1. If you hit these numbers, the AI differentiator is validated.</div>
    </div>
  </div>
</div>

<!-- File inputs -->
<input type="file" id="input-camera" accept="image/*" capture="environment">
<input type="file" id="input-upload" accept="image/*,.pdf">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  apiKey: '',
  useRealAPI: false,
  model: 'claude-sonnet-4-20250514',
  selectedResident: 'Dorothy M.',
  currentImage: null,
  currentResults: null,
  editingField: null,
  history: [],
  processStartTime: null,
};

const RESIDENTS = ['Dorothy M.', 'Robert K.', 'Helen W.', 'James T.', 'Patricia L.'];

const SYSTEM_PROMPT = `You are an expert medical prescription and doctor order extraction AI for an assisted living facility. You read handwritten, faxed, printed, and typed orders from photographs.

## PROCESS ‚Äî follow these 3 steps:

### STEP 1: RAW READ
Read everything on the document ‚Äî headers, patient info, prescriber info, every Rx line.

### STEP 2: MEDICAL INTERPRETATION
- Correct drug name misspellings (Topamex‚ÜíTopamax, Lipator‚ÜíLipitor, amlodapine‚ÜíAmlodipine, metforman‚ÜíMetformin, gabapenten‚ÜíGabapentin, levothyroxin‚ÜíLevothyroxine, omeprazol‚ÜíOmeprazole, lisinipril‚ÜíLisinopril, atorvistatin‚ÜíAtorvastatin)
- Decode ALL abbreviations to plain English (see reference below)
- Roman numerals for tablet counts: "IV tabs"=4 tablets, "ii caps"=2 capsules ‚Äî NOT intravenous
- Chemical formulas: FeSO4=Ferrous Sulfate (Iron), KCl=Potassium Chloride, CaCO3=Calcium Carbonate, NaHCO3=Sodium Bicarbonate, MgO=Magnesium Oxide
- Short names: ASA=Aspirin, APAP=Acetaminophen, MOM=Milk of Magnesia, MVI=Multivitamin, HCTZ=Hydrochlorothiazide, NTG=Nitroglycerin, PCN=Penicillin, SMZ-TMP=Sulfamethoxazole-Trimethoprim

### STEP 3: OUTPUT structured JSON

## ABBREVIATION REFERENCE ‚Äî always decode to plain English:

FREQUENCY: qd=once daily | bid=twice daily | tid=3 times daily | qid=4 times daily | prn=as needed | q4h/q6h/q8h/q12h=every 4/6/8/12 hours | qhs=at bedtime | ac=before meals | pc=after meals | A.D./ad/ud=as directed | stat=immediately | qam=every morning | qpm=every evening | qod=every other day | biw=twice weekly | tiw=3 times weekly

ROUTE: po/PO=by mouth | sl/SL=under the tongue | pr/PR=rectal | im/IM=intramuscular injection | iv/IV=intravenous | subq/sq/SC=subcutaneous injection | top=apply to skin | inh=inhaled | neb=via nebulizer | gtts=drops | OU=both eyes | OD=right eye | OS=left eye

FORM: tab/tabs=tablet(s) | cap/caps=capsule(s) | gtt/gtts=drop(s) | tsp=teaspoon 5mL | tbsp=tablespoon 15mL | susp=liquid suspension | sol=solution | ung/oint=ointment | cr=cream | supp=suppository | MDI=inhaler | patch=skin patch

QUANTITY: Sig/sig=directions | Disp/disp=dispense | #30=quantity 30 | i=1 ii=2 iii=3 iv=4 v=5 vi=6 (Roman numerals) | ss=half | aa=of each

OTHER: Rx=prescription | d/c/DC=discontinue | NKA=no known allergies | DAW=dispense as written | NR=no refill | NPO=nothing by mouth

## RULES:
1. Return ALL medications found. One form can have 1, 2, 3+ separate medications.
2. If compound formula (ingredients mixed together), set is_compound:true.
3. Every value MUST be PLAIN ENGLISH. Never return raw abbreviations. "po bid" must become "By mouth, twice daily"
4. If illegible, say "Unclear ‚Äî best guess: [guess]" and set confidence low.
5. Flag safety concerns in warnings array.
6. Dates in MM/DD/YYYY.

## OUTPUT ‚Äî Return ONLY this JSON, no backticks, no markdown:
{
  "medications": [
    {
      "name": "Full drug name (brand + generic if known)",
      "dosage": "Amount and unit",
      "route": "Plain English",
      "frequency": "Plain English",
      "form": "tablet, capsule, syrup, etc.",
      "instructions": "Complete plain-English directions for a caregiver",
      "quantity": "Amount dispensed if specified",
      "refills": "Number if specified",
      "prescriber": "Doctor name if visible",
      "date": "Order date if visible",
      "is_compound": false,
      "warnings": [],
      "confidence": 85
    }
  ],
  "patient_name": "If visible",
  "summary": "One plain-English sentence summarizing the entire order"
}`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  // Load saved state
  try {
    const saved = JSON.parse(localStorage.getItem('careos_state') || '{}');
    if (saved.apiKey) state.apiKey = saved.apiKey;
    if (saved.useRealAPI) state.useRealAPI = saved.useRealAPI;
    if (saved.model) state.model = saved.model;
    if (saved.history) state.history = saved.history;
  } catch(e) {}

  renderResidentChips();
  updateModeIndicator();
  updateStats();
  
  // Settings
  if (state.useRealAPI) {
    document.getElementById('toggle-api').classList.replace('off','on');
    document.getElementById('api-config').classList.remove('hidden');
  }
  if (state.apiKey) {
    document.getElementById('api-key-input').value = state.apiKey;
    document.getElementById('api-status').classList.remove('hidden');
  }
  document.getElementById('model-select').value = state.model;

  // Event listeners
  document.getElementById('btn-camera').addEventListener('click', () => document.getElementById('input-camera').click());
  document.getElementById('btn-upload').addEventListener('click', () => document.getElementById('input-upload').click());
  document.getElementById('input-camera').addEventListener('change', handleImage);
  document.getElementById('input-upload').addEventListener('change', handleImage);
  document.getElementById('model-select').addEventListener('change', (e) => { state.model = e.target.value; saveState(); });
}

function saveState() {
  localStorage.setItem('careos_state', JSON.stringify({
    apiKey: state.apiKey,
    useRealAPI: state.useRealAPI,
    model: state.model,
    history: state.history,
  }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  if (id === 'history') renderHistory();
  if (id === 'home') { updateStats(); updateModeIndicator(); }
  window.scrollTo(0, 0);
}

function resetAndHome() {
  state.currentImage = null;
  state.currentResults = null;
  state.editingField = null;
  // Reset file inputs
  document.getElementById('input-camera').value = '';
  document.getElementById('input-upload').value = '';
  showScreen('home');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESIDENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderResidentChips() {
  const container = document.getElementById('resident-chips');
  container.innerHTML = RESIDENTS.map(name => 
    `<div class="resident-chip ${name === state.selectedResident ? 'active' : ''}" onclick="selectResident('${name}')">${name}</div>`
  ).join('');
}

function selectResident(name) {
  state.selectedResident = name;
  renderResidentChips();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateModeIndicator() {
  const el = document.getElementById('mode-indicator');
  const txt = document.getElementById('mode-text');
  if (state.useRealAPI && state.apiKey) {
    el.className = 'mode-bar live';
    txt.textContent = 'LIVE MODE ‚Äî Connected to Claude API';
  } else {
    el.className = 'mode-bar demo';
    txt.textContent = 'Setup needed ‚Äî add API key in Settings';
  }
}

function updateStats() {
  document.getElementById('stat-processed').textContent = state.history.length;
  if (state.history.length > 0) {
    const avg = Math.round(state.history.reduce((s,h) => s + h.avgConfidence, 0) / state.history.length);
    document.getElementById('stat-accuracy').textContent = avg + '%';
    const edited = state.history.reduce((s,h) => s + h.fieldsEdited, 0);
    document.getElementById('stat-edited').textContent = edited;
  } else {
    document.getElementById('stat-accuracy').textContent = '‚Äî';
    document.getElementById('stat-edited').textContent = '0';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAPI() {
  state.useRealAPI = !state.useRealAPI;
  const btn = document.getElementById('toggle-api');
  const config = document.getElementById('api-config');
  btn.classList.toggle('on'); btn.classList.toggle('off');
  if (state.useRealAPI) { config.classList.remove('hidden'); } else { config.classList.add('hidden'); }
  saveState(); updateModeIndicator();
}

function onApiKeyInput() {
  state.apiKey = document.getElementById('api-key-input').value.trim();
  const status = document.getElementById('api-status');
  if (state.apiKey.length > 10) { status.classList.remove('hidden'); } else { status.classList.add('hidden'); }
  saveState(); updateModeIndicator();
}

function clearAllData() {
  if (confirm('Clear all history and settings?')) {
    state.history = [];
    state.apiKey = '';
    state.useRealAPI = false;
    localStorage.removeItem('careos_state');
    document.getElementById('api-key-input').value = '';
    document.getElementById('api-status').classList.add('hidden');
    document.getElementById('toggle-api').classList.replace('on','off');
    document.getElementById('api-config').classList.add('hidden');
    updateStats(); updateModeIndicator();
    alert('All data cleared.');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMAGE HANDLING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleImage(e) {
  const file = e.target.files?.[0];
  if (!file) return;
  
  state.processStartTime = Date.now();
  showScreen('processing');
  document.getElementById('processing-step').textContent = 'Preparing image...';
  
  // Compress image to stay under Claude's 5MB limit
  compressImage(file, 4.5 * 1024 * 1024).then(dataUrl => {
    state.currentImage = dataUrl;
    const preview = document.getElementById('processing-preview');
    preview.innerHTML = `<img src="${state.currentImage}" alt="Order">`;
    processOrder();
  }).catch(err => {
    alert('Error processing image: ' + err.message);
    showScreen('home');
  });
}

function compressImage(file, maxBytes) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        // Start with original size, scale down if needed
        let quality = 0.85;
        let maxDim = 2400; // Max dimension in pixels
        
        function tryCompress() {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          
          // Scale down if larger than maxDim
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          
          // Check size (base64 is ~33% larger than binary)
          const base64 = dataUrl.split(',')[1];
          const bytes = base64.length * 0.75;
          
          if (bytes > maxBytes && quality > 0.3) {
            // Try again with lower quality or smaller size
            quality -= 0.15;
            if (quality < 0.5) maxDim = Math.round(maxDim * 0.75);
            tryCompress();
          } else {
            resolve(dataUrl);
          }
        }
        tryCompress();
      };
      img.onerror = () => reject(new Error('Could not load image'));
      img.src = ev.target.result;
    };
    reader.onerror = () => reject(new Error('Could not read file'));
    reader.readAsDataURL(file);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROCESS ORDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function processOrder() {
  const stepEl = document.getElementById('processing-step');

  if (!state.useRealAPI || !state.apiKey) {
    alert('Please add your API key in Settings first.');
    showScreen('home');
    return;
  }

  // ‚îÄ‚îÄ‚îÄ REAL API ‚îÄ‚îÄ‚îÄ
  try {
    stepEl.textContent = 'Connecting to Claude API...';
    await sleep(400);
    
    stepEl.textContent = 'Sending image for analysis...';
    const base64 = state.currentImage.split(',')[1];
    const mediaType = state.currentImage.split(';')[0].split(':')[1] || 'image/jpeg';

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: state.model,
        max_tokens: 4096,
        system: SYSTEM_PROMPT,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
            { type: 'text', text: 'Read this doctor\'s order or prescription. Extract every medication. Decode all abbreviations into plain English. Return the JSON.' }
          ]
        }]
      })
    });

    stepEl.textContent = 'Reading AI response...';

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || 'API error: ' + response.status);
    }

    const data = await response.json();
    const text = data.content?.[0]?.text || '';

    stepEl.textContent = 'Parsing results...';
    await sleep(300);

    const jsonStr = text.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    let parsed = JSON.parse(jsonStr);

    // ‚îÄ‚îÄ‚îÄ TWO-PASS VERIFICATION ‚îÄ‚îÄ‚îÄ
    const lowConf = parsed.medications?.some(m => (m.confidence || 100) < 55);
    if (lowConf) {
      stepEl.textContent = 'Double-checking unclear fields...';
      try {
        const verifyRes = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
          },
          body: JSON.stringify({
            model: state.model,
            max_tokens: 2048,
            messages: [{
              role: 'user',
              content: [
                { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
                { type: 'text', text: 'First read returned: ' + JSON.stringify(parsed.medications) + '\n\nSome had low confidence. Look again carefully at the medication names and dosages. Return the same JSON structure with corrections. Only change what you are more sure about.' }
              ]
            }]
          })
        });
        if (verifyRes.ok) {
          const vData = await verifyRes.json();
          const vText = vData.content?.[0]?.text || '';
          try {
            const vParsed = JSON.parse(vText.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim());
            if (vParsed.medications) parsed.medications = vParsed.medications;
            else if (Array.isArray(vParsed)) parsed.medications = vParsed;
          } catch(e) {}
        }
      } catch(e) {}
    }

    // ‚îÄ‚îÄ‚îÄ ADAPT MULTI-MED RESPONSE TO FLAT FIELD LIST ‚îÄ‚îÄ‚îÄ
    const meds = parsed.medications || [];
    const fields = [];

    meds.forEach((med, idx) => {
      const p = meds.length > 1 ? '(' + (idx+1) + ' of ' + meds.length + ') ' : '';
      const c = med.confidence || 80;

      if (med.name) fields.push({key:'medication_'+idx, label:p+'Medication', value:med.name, confidence:c, edited:false});
      if (med.dosage && med.dosage !== 'Not specified') fields.push({key:'dosage_'+idx, label:p+'Dosage', value:med.dosage, confidence:c, edited:false});
      if (med.route && med.route !== 'Not specified') fields.push({key:'route_'+idx, label:p+'Route', value:med.route, confidence:Math.min(c+5,99), edited:false});
      if (med.frequency && med.frequency !== 'Not specified') fields.push({key:'frequency_'+idx, label:p+'Frequency', value:med.frequency, confidence:c, edited:false});
      if (med.form && med.form !== 'Not specified') fields.push({key:'form_'+idx, label:p+'Form', value:med.form, confidence:c, edited:false});
      if (med.prescriber && med.prescriber !== 'Not specified') fields.push({key:'prescriber_'+idx, label:p+'Prescriber', value:med.prescriber, confidence:90, edited:false});
      if (med.date && med.date !== 'Not specified') fields.push({key:'date_'+idx, label:p+'Date', value:med.date, confidence:85, edited:false});
      if (med.instructions && med.instructions !== 'Not specified') fields.push({key:'instructions_'+idx, label:p+'Directions', value:med.instructions, confidence:c, edited:false});
      if (med.quantity && med.quantity !== 'Not specified') fields.push({key:'quantity_'+idx, label:p+'Quantity', value:med.quantity, confidence:88, edited:false});
      if (med.refills && med.refills !== 'Not specified') fields.push({key:'refills_'+idx, label:p+'Refills', value:String(med.refills), confidence:90, edited:false});
      if (med.warnings && med.warnings.length > 0) {
        fields.push({key:'warnings_'+idx, label:p+'‚ö† Needs Review', value:med.warnings.join('. '), confidence:45, edited:false, isWarning:true});
      }
    });

    state.currentResults = {
      summary: parsed.summary || '',
      medCount: meds.length,
      patient: parsed.patient_name || '',
      fields: fields,
      isLive: true,
    };

    showScreen('results');
    renderResults();

  } catch(err) {
    alert('API Error: ' + err.message);
    showScreen('home');
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER RESULTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderResults() {
  const r = state.currentResults;
  document.getElementById('results-subtitle').textContent =
    'For ' + state.selectedResident + (r.patient ? ' ¬∑ Patient: ' + r.patient : '') + ' ¬∑ Live API';

  const scroll = document.getElementById('results-scroll');
  let html = '';

  // Banner
  const bannerText = r.medCount > 1 ? r.medCount + ' Medications Found' : 'Extraction Complete';
  html += '<div class="result-banner success">' +
    '<span class="rb-icon">‚úì</span>' +
    '<div><div class="rb-text">' + bannerText + '</div>' +
    '<div class="rb-sub">' + r.summary + ' ¬∑ Tap any field to edit</div></div></div>';

  // Image preview
  if (state.currentImage) {
    html += '<div class="result-preview"><img src="' + state.currentImage + '" alt="Order"></div>';
  }

  // Fields with medication dividers
  let currentMedIdx = -1;
  r.fields.forEach((f, i) => {
    const match = f.key.match(/_(\d+)$/);
    const medIdx = match ? parseInt(match[1]) : 0;

    // Add divider between medications
    if (r.medCount > 1 && medIdx !== currentMedIdx && medIdx > 0 && f.key.startsWith('medication_')) {
      html += '<div class="med-divider">Medication ' + (medIdx + 1) + '</div>';
    }
    if (f.key.startsWith('medication_')) currentMedIdx = medIdx;

    const confClass = f.confidence >= 90 ? 'conf-high' : f.confidence >= 75 ? 'conf-mid' : 'conf-low';
    const fieldClass = f.isWarning ? 'result-field warning-field' : f.edited ? 'result-field edited' : 'result-field';

    html += '<div class="' + fieldClass + '" id="field-' + i + '" onclick="startEdit(' + i + ')">' +
      '<div class="result-field-top"><div>' +
      '<span class="result-field-label">' + f.label + '</span>' +
      (f.edited ? '<span class="edited-tag">EDITED</span>' : '') +
      '</div><span class="confidence-badge ' + confClass + '">' + f.confidence + '%</span></div>' +
      '<div class="result-field-value"' + (f.isWarning ? ' style="color:var(--warning)"' : '') + '>' + f.value + '</div>' +
      (f.confidence < 75 && !f.edited && !f.isWarning ? '<div class="low-conf-warning">‚ö†Ô∏è Low confidence ‚Äî please verify</div>' : '') +
      '</div>';
  });

  scroll.innerHTML = html;
  updateConfirmStats();
}

function startEdit(idx) {
  if (state.editingField !== null) return;
  state.editingField = idx;
  const field = state.currentResults.fields[idx];
  const el = document.getElementById('field-' + idx);
  const valueEl = el.querySelector('.result-field-value');
  const warnEl = el.querySelector('.low-conf-warning');
  if (warnEl) warnEl.style.display = 'none';
  
  valueEl.innerHTML = `<div class="edit-row">
    <input class="edit-input" id="edit-input" value="${field.value.replace(/"/g,'&quot;')}" autofocus>
    <button class="edit-save" onclick="event.stopPropagation(); saveEdit(${idx})">Save</button>
    <button class="edit-cancel" onclick="event.stopPropagation(); cancelEdit()">‚úï</button>
  </div>`;
  
  setTimeout(() => document.getElementById('edit-input')?.focus(), 50);
}

function saveEdit(idx) {
  const input = document.getElementById('edit-input');
  if (input && input.value.trim()) {
    state.currentResults.fields[idx].value = input.value.trim();
    state.currentResults.fields[idx].edited = true;
    state.currentResults.fields[idx].confidence = 100;
  }
  state.editingField = null;
  renderResults();
}

function cancelEdit() {
  state.editingField = null;
  renderResults();
}

function updateConfirmStats() {
  const fields = state.currentResults.fields;
  const avg = Math.round(fields.reduce((s,f) => s + f.confidence, 0) / fields.length);
  const edited = fields.filter(f => f.edited).length;
  document.getElementById('confirm-stats').textContent = 
    `Avg confidence: ${avg}% ¬∑ ${edited} field${edited !== 1 ? 's' : ''} edited`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIRM ORDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmOrder() {
  const r = state.currentResults;
  const elapsed = Math.round((Date.now() - state.processStartTime) / 1000);
  
  const entry = {
    timestamp: new Date().toISOString(),
    displayTime: new Date().toLocaleString(),
    resident: state.selectedResident,
    medication: r.fields.filter(f => f.key.startsWith('medication_')).map(f => f.value).join(' + ') || 'Unknown',
    medCount: r.medCount || 1,
    orderType: r.order_type,
    summary: r.summary,
    fieldsEdited: r.fields.filter(f => f.edited).length,
    totalFields: r.fields.length,
    avgConfidence: Math.round(r.fields.reduce((s,f) => s + f.confidence, 0) / r.fields.length),
    isLive: r.isLive,
    processingTime: elapsed,
    allFields: r.fields.map(f => ({ key: f.key, value: f.value, confidence: f.confidence, edited: f.edited })),
  };
  
  state.history.unshift(entry);
  saveState();

  // Update confirmed screen
  document.getElementById('confirmed-med').textContent = entry.medication;
  document.getElementById('confirmed-resident').textContent = 'For ' + entry.resident + (entry.medCount > 1 ? ' ¬∑ ' + entry.medCount + ' medications' : '');
  document.getElementById('confirmed-time').textContent = `Processing time: ${elapsed} seconds`;
  document.getElementById('confirmed-count').textContent = state.history.length;

  showScreen('confirmed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory() {
  const container = document.getElementById('history-scroll');
  if (state.history.length === 0) {
    container.innerHTML = `<div class="history-empty">
      <div class="history-empty-icon">üìã</div>
      <div style="font-size:15px;font-weight:600;">No orders processed yet</div>
      <div style="font-size:13px;margin-top:4px;">Take a photo of a doctor's order to get started</div>
    </div>`;
    return;
  }

  container.innerHTML = state.history.map((h, i) => {
    const accColor = h.avgConfidence >= 90 ? 'var(--success)' : h.avgConfidence >= 75 ? 'var(--warning)' : 'var(--danger)';
    return `<div class="history-card">
      <div class="hc-top">
        <div>
          <div class="hc-med">${h.medication}</div>
          <div class="hc-dose">${h.resident}${h.medCount > 1 ? ' ¬∑ ' + h.medCount + ' meds' : ''}</div>
        </div>
        <span class="hc-badge ${h.isLive ? 'hc-live' : 'hc-demo'}">${h.isLive ? 'LIVE' : 'DEMO'}</span>
      </div>
      <div class="hc-accuracy">
        <div class="hc-accuracy-bar">
          <div class="hc-accuracy-fill" style="width:${h.avgConfidence}%;background:${accColor}"></div>
        </div>
        <div class="hc-accuracy-text" style="color:${accColor}">${h.avgConfidence}%</div>
      </div>
      <div class="hc-meta">
        <span>‚è± ${h.processingTime}s</span>
        <span>‚úèÔ∏è ${h.fieldsEdited}/${h.totalFields} edited</span>
        <span>${h.displayTime}</span>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
