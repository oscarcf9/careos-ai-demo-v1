<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CareOS AI">
<meta name="theme-color" content="#0B1A2B">
<title>CareOS AI Demo</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>

:root {
  --primary: #1B7A9E;
  --primary-light: #2A9BC2;
  --primary-soft: #E4F3F9;
  --primary-glow: rgba(27,122,158,0.15);
  --accent: #E56B3E;
  --accent-soft: #FFF1EC;
  --success: #1DA362;
  --success-soft: #E3F6EC;
  --warning: #C88B0A;
  --warning-soft: #FFF7E0;
  --danger: #C0392B;
  --danger-soft: #FCE8E6;
  --bg: #F5F7FA;
  --card: #FFFFFF;
  --card-hover: #FAFBFC;
  --border: #E0E5EC;
  --border-light: #EEF1F5;
  --text: #0F1D2F;
  --text-sec: #4A5B72;
  --text-muted: #8697AB;
  --shadow-sm: 0 1px 3px rgba(15,29,47,0.06), 0 1px 2px rgba(15,29,47,0.04);
  --shadow-md: 0 4px 12px rgba(15,29,47,0.08), 0 2px 4px rgba(15,29,47,0.04);
  --shadow-lg: 0 12px 40px rgba(15,29,47,0.12), 0 4px 12px rgba(15,29,47,0.06);
  --radius: 14px;
  --radius-sm: 10px;
  --radius-lg: 18px;
  --radius-xl: 24px;
  --radius-full: 999px;
  --font: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --nav-height: 68px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { 
  font-family: var(--font); background: var(--bg); color: var(--text); 
  min-height: 100vh; min-height: 100dvh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ─── SCREEN MANAGEMENT ─── */
.screen { display: none; min-height: 100vh; min-height: 100dvh; flex-direction: column; padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 8px); }
.screen.active { display: flex; }
.screen.no-nav { padding-bottom: 0; }

/* ─── BOTTOM NAV ─── */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
  background: var(--card);
  border-top: 1px solid var(--border);
  padding: 6px 8px calc(var(--safe-bottom) + 6px);
  display: flex; justify-content: space-around; align-items: center;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 6px 12px; border-radius: var(--radius-sm); cursor: pointer;
  transition: all 0.15s; border: none; background: none;
  min-width: 56px; position: relative;
}
.nav-item:active { transform: scale(0.92); }
.nav-icon { font-size: 22px; line-height: 1; }
.nav-label { font-size: 10px; font-weight: 600; color: var(--text-muted); }
.nav-item.active .nav-label { color: var(--primary); font-weight: 700; }
.nav-item.active::after {
  content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
  width: 24px; height: 3px; border-radius: 2px; background: var(--primary);
}
.nav-item.scan-btn .nav-icon {
  width: 36px; height: 36px; border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex; align-items: center; justify-content: center;
  color: white;
}
.nav-badge {
  position: absolute; top: 2px; right: 8px; min-width: 16px; height: 16px;
  border-radius: 8px; background: var(--accent); color: white;
  font-size: 9px; font-weight: 800; display: flex; align-items: center;
  justify-content: center; padding: 0 4px;
}

/* ─── TOP BAR ─── */
.topbar {
  padding: calc(var(--safe-top) + 12px) 20px 14px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.topbar-row { display: flex; align-items: center; gap: 12px; }
.topbar-back {
  width: 38px; height: 38px; border-radius: var(--radius-sm); background: var(--bg);
  display: flex; align-items: center; justify-content: center; border: none; cursor: pointer;
  color: var(--text); font-size: 18px;
}
.topbar-title { font-size: 19px; font-weight: 700; letter-spacing: -0.3px; flex: 1; }
.topbar-subtitle { font-size: 12px; color: var(--text-sec); margin-top: 2px; }
.topbar-action {
  padding: 7px 14px; border-radius: var(--radius-full); font-size: 12px;
  font-weight: 700; border: none; cursor: pointer; font-family: var(--font);
}

/* ─── OFFLINE INDICATOR ─── */
.offline-bar {
  padding: 6px 16px; background: var(--danger); color: white;
  text-align: center; font-size: 11px; font-weight: 700;
  display: none; align-items: center; justify-content: center; gap: 6px;
}
.offline-bar.show { display: flex; }

/* ─── HOME SCREEN ─── */
.home-header {
  padding: calc(var(--safe-top) + 16px) 20px 16px;
  background: linear-gradient(135deg, #0B1A2B 0%, #132D4A 100%);
  color: white;
}
.home-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.home-logo-icon {
  width: 40px; height: 40px; border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex; align-items: center; justify-content: center; font-size: 18px;
}
.home-logo-text { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
.home-logo-badge {
  font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.15);
  padding: 3px 8px; border-radius: var(--radius-full); margin-left: auto;
}
.home-stats {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;
}
.home-stat {
  background: rgba(255,255,255,0.08); border-radius: var(--radius-sm);
  padding: 10px 12px; text-align: center; border: 1px solid rgba(255,255,255,0.06);
}
.home-stat-value { font-size: 22px; font-weight: 800; }
.home-stat-label { font-size: 10px; opacity: 0.6; margin-top: 2px; font-weight: 500; }

/* ─── MODE INDICATOR ─── */
.mode-bar {
  margin: 16px 20px 0; padding: 10px 14px; border-radius: var(--radius);
  display: flex; align-items: center; gap: 10px;
  font-size: 12px; font-weight: 600;
}
.mode-bar.live { background: var(--success-soft); color: var(--success); border: 1px solid rgba(29,163,98,0.2); }
.mode-bar.demo { background: var(--warning-soft); color: var(--warning); border: 1px solid rgba(200,139,10,0.2); }
.mode-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.mode-bar.live .mode-dot { background: var(--success); animation: pulse 2s infinite; }
.mode-bar.demo .mode-dot { background: var(--warning); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* ─── PENDING ORDERS ALERT ─── */
.pending-alert {
  margin: 12px 20px 0; padding: 12px 14px; border-radius: var(--radius);
  background: var(--accent-soft); border: 1px solid rgba(229,107,62,0.2);
  display: flex; align-items: center; gap: 10px; cursor: pointer;
  transition: all 0.15s;
}
.pending-alert:active { transform: scale(0.98); }
.pending-alert-icon { font-size: 20px; }
.pending-alert-text { flex: 1; }
.pending-alert-title { font-size: 13px; font-weight: 700; color: var(--accent); }
.pending-alert-sub { font-size: 11px; color: var(--accent); opacity: 0.8; }
.pending-alert-arrow { font-size: 16px; color: var(--accent); }

/* ─── QUICK ACTIONS ─── */
.quick-actions { padding: 16px 20px 8px; }
.quick-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.quick-card {
  padding: 16px; border-radius: var(--radius); background: var(--card);
  border: 1.5px solid var(--border); cursor: pointer; transition: all 0.15s;
  box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 8px;
}
.quick-card:active { transform: scale(0.97); background: var(--card-hover); }
.quick-icon { font-size: 28px; }
.quick-label { font-size: 14px; font-weight: 700; }
.quick-desc { font-size: 11px; color: var(--text-sec); line-height: 1.4; }

/* ─── SECTION LABEL ─── */
.section-label {
  font-size: 11px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;
}
.section-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px 20px 8px;
}
.section-link { font-size: 12px; font-weight: 700; color: var(--primary); cursor: pointer; }

/* ─── RECENT ACTIVITY (HOME) ─── */
.recent-section { padding: 0 20px 16px; }
.recent-card {
  padding: 12px 14px; background: var(--card); border-radius: var(--radius);
  border: 1px solid var(--border); box-shadow: var(--shadow-sm); margin-bottom: 8px;
  display: flex; align-items: center; gap: 12px;
}
.recent-avatar {
  width: 40px; height: 40px; border-radius: 50%; display: flex;
  align-items: center; justify-content: center; font-size: 16px;
  font-weight: 800; color: white; flex-shrink: 0;
}
.recent-info { flex: 1; min-width: 0; }
.recent-name { font-size: 13px; font-weight: 700; }
.recent-detail { font-size: 11px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.recent-meta { font-size: 10px; color: var(--text-muted); text-align: right; white-space: nowrap; }

/* ─── RESIDENTS SCREEN ─── */
.residents-scroll { flex: 1; overflow-y: auto; padding: 12px 16px; }
.resident-card {
  padding: 14px; margin-bottom: 10px; background: var(--card);
  border-radius: var(--radius); border: 1.5px solid var(--border);
  box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.15s;
}
.resident-card:active { transform: scale(0.98); }
.rc-top { display: flex; align-items: center; gap: 12px; }
.rc-avatar {
  width: 48px; height: 48px; border-radius: 50%; display: flex;
  align-items: center; justify-content: center; font-size: 18px;
  font-weight: 800; color: white; flex-shrink: 0;
}
.rc-info { flex: 1; }
.rc-name { font-size: 16px; font-weight: 700; }
.rc-detail { font-size: 12px; color: var(--text-sec); margin-top: 2px; }
.rc-badges { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.rc-badge {
  font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: var(--radius-full);
}
.rc-badge.meds { background: var(--primary-soft); color: var(--primary); }
.rc-badge.pending { background: var(--accent-soft); color: var(--accent); }
.rc-badge.allergy { background: var(--danger-soft); color: var(--danger); }
.rc-arrow { font-size: 18px; color: var(--text-muted); }

/* ─── RESIDENT PROFILE SCREEN ─── */
.profile-header {
  padding: 20px; text-align: center; background: var(--card);
  border-bottom: 1px solid var(--border);
}
.profile-avatar {
  width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; font-weight: 800; color: white;
}
.profile-name { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
.profile-sub { font-size: 13px; color: var(--text-sec); margin-top: 4px; }
.profile-allergy-bar {
  margin: 12px auto 0; padding: 6px 16px; border-radius: var(--radius-full);
  background: var(--danger-soft); border: 1px solid rgba(192,57,43,0.25);
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 12px; font-weight: 700; color: var(--danger);
}
.profile-scroll { flex: 1; overflow-y: auto; padding: 12px 16px; }
.profile-section {
  padding: 14px; margin-bottom: 10px; background: var(--card);
  border-radius: var(--radius); border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.ps-title {
  font-size: 11px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
}
.ps-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-light); }
.ps-row:last-child { border-bottom: none; }
.ps-label { font-size: 12px; color: var(--text-sec); }
.ps-value { font-size: 12px; font-weight: 600; text-align: right; max-width: 60%; }

/* ─── ACTIVE MEDS LIST ─── */
.med-list-card {
  padding: 12px; margin-bottom: 8px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); background: var(--card);
}
.ml-top { display: flex; justify-content: space-between; align-items: flex-start; }
.ml-name { font-size: 14px; font-weight: 700; }
.ml-dose { font-size: 12px; color: var(--text-sec); margin-top: 2px; }
.ml-status {
  font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: var(--radius-full);
  white-space: nowrap;
}
.ml-status.active { background: var(--success-soft); color: var(--success); }
.ml-status.pending { background: var(--accent-soft); color: var(--accent); }
.ml-freq { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
.ml-confirm-btn {
  margin-top: 8px; padding: 8px; border-radius: var(--radius-sm);
  background: var(--accent); color: white; border: none; cursor: pointer;
  font-family: var(--font); font-size: 12px; font-weight: 700; width: 100%;
  transition: all 0.15s;
}
.ml-confirm-btn:active { transform: scale(0.97); }

/* ─── CAPTURE AREA ─── */
.capture-section { padding: 8px 20px 20px; flex: 1; display: flex; flex-direction: column; gap: 12px; }
.capture-main {
  flex: 1; min-height: 200px; border: 2.5px dashed rgba(27,122,158,0.35);
  border-radius: var(--radius-xl); background: linear-gradient(145deg, var(--primary-soft), #EDF5F8);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 14px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
}
.capture-main:active { transform: scale(0.98); }
.capture-icon {
  width: 72px; height: 72px; border-radius: 22px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 8px 28px rgba(27,122,158,0.3); font-size: 30px; color: white;
}
.capture-text { font-size: 17px; font-weight: 700; color: var(--primary); }
.capture-subtext { font-size: 13px; color: var(--text-sec); }

.capture-upload {
  padding: 14px; border-radius: var(--radius); background: var(--card);
  border: 1.5px solid var(--border); display: flex; align-items: center;
  justify-content: center; gap: 10px; cursor: pointer; font-size: 14px;
  font-weight: 600; color: var(--text-sec); transition: all 0.15s;
}
.capture-upload:active { background: var(--bg); }

/* ─── SAMPLE ORDERS ─── */
.sample-section { padding: 0 20px 12px; }
.sample-strip { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
.sample-strip::-webkit-scrollbar { display: none; }
.sample-card {
  min-width: 120px; padding: 10px; border-radius: var(--radius-sm);
  background: var(--card); border: 1.5px solid var(--border);
  cursor: pointer; transition: all 0.15s; text-align: center;
  flex-shrink: 0;
}
.sample-card:active { transform: scale(0.95); border-color: var(--primary); }
.sample-icon { font-size: 24px; margin-bottom: 4px; }
.sample-label { font-size: 11px; font-weight: 700; color: var(--text-sec); }

.info-box {
  padding: 12px 14px; border-radius: var(--radius); display: flex;
  align-items: flex-start; gap: 10px; font-size: 12px; line-height: 1.5;
}
.info-box.accent { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(229,107,62,0.2); }
.info-box.success { background: var(--success-soft); color: var(--success); border: 1px solid rgba(29,163,98,0.2); }
.info-box.warning { background: var(--warning-soft); color: var(--warning); border: 1px solid rgba(200,139,10,0.2); }
.info-box.danger { background: var(--danger-soft); color: var(--danger); border: 1px solid rgba(192,57,43,0.2); }
.info-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

/* ─── RESIDENT SELECTOR (SCAN SCREEN) ─── */
.resident-section { padding: 16px 20px 8px; }
.resident-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
.resident-chips::-webkit-scrollbar { display: none; }
.resident-chip {
  padding: 8px 16px; border-radius: var(--radius-full); font-size: 13px; font-weight: 600;
  white-space: nowrap; cursor: pointer; border: 1.5px solid var(--border);
  background: var(--card); color: var(--text); transition: all 0.15s;
}
.resident-chip.active {
  background: var(--primary); color: white; border-color: var(--primary);
}

/* ─── PROCESSING SCREEN ─── */
.processing-center {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 40px 32px; text-align: center;
}
.processing-preview {
  width: 180px; height: 130px; border-radius: var(--radius); overflow: hidden;
  border: 2px solid var(--border); box-shadow: var(--shadow-md); margin-bottom: 28px;
}
.processing-preview img { width: 100%; height: 100%; object-fit: cover; }
.spinner {
  width: 52px; height: 52px; border: 4px solid var(--border-light);
  border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
  margin-bottom: 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.processing-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
.processing-step { font-size: 14px; color: var(--text-sec); }
.processing-dots { display: flex; gap: 6px; margin-top: 16px; }
.processing-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--primary);
  animation: dotPulse 1.4s ease-in-out infinite;
}
.processing-dot:nth-child(2) { animation-delay: 0.2s; }
.processing-dot:nth-child(3) { animation-delay: 0.4s; }
.processing-dot:nth-child(4) { animation-delay: 0.6s; }
@keyframes dotPulse { 0%,100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }

/* ─── RESULTS SCREEN ─── */
.results-scroll { flex: 1; overflow-y: auto; padding: 12px 16px 100px; }
.result-banner {
  padding: 10px 14px; border-radius: var(--radius); display: flex;
  align-items: center; gap: 10px; margin-bottom: 12px;
}
.result-banner.success { background: var(--success-soft); border: 1px solid rgba(29,163,98,0.2); }
.result-banner.warning { background: var(--warning-soft); border: 1px solid rgba(200,139,10,0.2); }
.result-banner .rb-icon { font-size: 18px; }
.result-banner .rb-text { font-size: 13px; font-weight: 700; }
.result-banner .rb-sub { font-size: 11px; opacity: 0.8; }

.result-preview {
  height: 72px; border-radius: var(--radius-sm); overflow: hidden;
  border: 1px solid var(--border); margin-bottom: 12px;
}
.result-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }

.result-field {
  padding: 13px 14px; margin-bottom: 8px; background: var(--card);
  border-radius: var(--radius); border: 1.5px solid var(--border);
  cursor: pointer; transition: all 0.15s; box-shadow: var(--shadow-sm);
}
.result-field:active { transform: scale(0.99); }
.result-field.edited { border-color: var(--primary); }
.result-field-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.result-field-label {
  font-size: 10px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.edited-tag {
  font-size: 9px; font-weight: 700; color: var(--primary);
  background: var(--primary-soft); padding: 2px 7px; border-radius: var(--radius-full);
  margin-left: 6px;
}
.confidence-badge {
  font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: var(--radius-full);
}
.conf-high { color: var(--success); background: var(--success-soft); }
.conf-mid { color: var(--warning); background: var(--warning-soft); }
.conf-low { color: var(--danger); background: var(--danger-soft); }
.result-field-value { font-size: 15px; font-weight: 600; line-height: 1.4; }
.low-conf-warning {
  margin-top: 6px; font-size: 11px; color: var(--warning);
  display: flex; align-items: center; gap: 4px;
}

/* Duplicate warning */
.dup-warning {
  padding: 10px 14px; border-radius: var(--radius); margin-bottom: 12px;
  background: var(--warning-soft); border: 1px solid rgba(200,139,10,0.25);
  display: flex; align-items: flex-start; gap: 10px;
}
.dup-warning-icon { font-size: 20px; flex-shrink: 0; }
.dup-warning-text { font-size: 12px; color: var(--warning); line-height: 1.5; }
.dup-warning-title { font-weight: 700; margin-bottom: 2px; }

/* Edit mode */
.edit-row { display: flex; gap: 8px; margin-top: 8px; }
.edit-input {
  flex: 1; padding: 9px 12px; border-radius: var(--radius-sm);
  border: 2px solid var(--primary); font-size: 14px; font-weight: 600;
  color: var(--text); font-family: var(--font); outline: none;
}
.edit-save {
  padding: 9px 18px; border-radius: var(--radius-sm); background: var(--primary);
  color: white; font-size: 13px; font-weight: 700; border: none; cursor: pointer;
  font-family: var(--font);
}
.edit-cancel {
  padding: 9px 14px; border-radius: var(--radius-sm); background: var(--bg);
  color: var(--text-sec); font-size: 13px; font-weight: 600; border: 1px solid var(--border);
  cursor: pointer; font-family: var(--font);
}

/* Fixed bottom confirm */
.results-bottom {
  position: fixed; bottom: 0; left: 0; right: 0; max-width: 100%;
  padding: 12px 16px calc(var(--safe-bottom) + 16px);
  background: linear-gradient(transparent, var(--bg) 20%);
  z-index: 150;
}
.confirm-stats { font-size: 11px; color: var(--text-muted); text-align: center; margin-bottom: 8px; }
.btn-confirm {
  width: 100%; padding: 16px; border-radius: var(--radius-lg); border: none;
  font-size: 16px; font-weight: 700; cursor: pointer; font-family: var(--font);
  background: linear-gradient(135deg, var(--success), var(--primary));
  color: white; box-shadow: 0 4px 20px rgba(29,163,98,0.35);
  transition: all 0.2s;
}
.btn-confirm:active { transform: scale(0.98); }
.pending-note { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 6px; }

/* ─── CONFIRMED SCREEN ─── */
.confirmed-center {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 40px 32px;
}
.confirmed-check {
  width: 88px; height: 88px; border-radius: 50%; background: var(--success-soft);
  display: flex; align-items: center; justify-content: center;
  font-size: 44px; margin-bottom: 20px;
  animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes scaleIn { from { transform: scale(0); } to { transform: scale(1); } }
.confirmed-title { font-size: 24px; font-weight: 800; margin-bottom: 6px; letter-spacing: -0.5px; }
.confirmed-med { font-size: 15px; color: var(--text-sec); margin-bottom: 4px; }
.confirmed-resident { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
.confirmed-time-badge {
  padding: 6px 16px; border-radius: var(--radius-full);
  background: var(--success-soft); border: 1px solid rgba(29,163,98,0.2);
  font-size: 12px; font-weight: 600; color: var(--success); margin-bottom: 28px;
}
.confirmed-status {
  padding: 6px 16px; border-radius: var(--radius-full);
  background: var(--warning-soft); border: 1px solid rgba(200,139,10,0.2);
  font-size: 12px; font-weight: 600; color: var(--warning); margin-bottom: 32px;
}
.btn-primary {
  width: 100%; padding: 15px; border-radius: var(--radius-lg); border: none;
  font-size: 15px; font-weight: 700; cursor: pointer; font-family: var(--font);
  background: var(--primary); color: white; margin-bottom: 10px;
}
.btn-secondary {
  width: 100%; padding: 14px; border-radius: var(--radius); border: 1.5px solid var(--border);
  font-size: 14px; font-weight: 600; cursor: pointer; font-family: var(--font);
  background: var(--card); color: var(--text);
}

/* ─── HISTORY SCREEN ─── */
.history-scroll { flex: 1; overflow-y: auto; padding: 12px 16px; }
.history-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
.history-empty-icon { font-size: 40px; margin-bottom: 12px; }
.history-card {
  padding: 14px; margin-bottom: 10px; background: var(--card);
  border-radius: var(--radius); border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.hc-top { display: flex; justify-content: space-between; align-items: flex-start; }
.hc-med { font-size: 15px; font-weight: 700; }
.hc-dose { font-size: 12px; color: var(--text-sec); margin-top: 2px; }
.hc-badge {
  font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: var(--radius-full);
}
.hc-live { color: var(--success); background: var(--success-soft); }
.hc-demo { color: var(--warning); background: var(--warning-soft); }
.hc-meta { display: flex; gap: 14px; margin-top: 10px; font-size: 11px; color: var(--text-muted); }
.hc-accuracy {
  margin-top: 8px; display: flex; align-items: center; gap: 8px;
}
.hc-accuracy-bar { flex: 1; height: 4px; background: var(--border-light); border-radius: 2px; overflow: hidden; }
.hc-accuracy-fill { height: 100%; border-radius: 2px; }
.hc-accuracy-text { font-size: 11px; font-weight: 700; min-width: 32px; text-align: right; }

.export-btn {
  margin: 8px 0; padding: 12px; border-radius: var(--radius); background: var(--primary-soft);
  border: 1px solid rgba(27,122,158,0.15); text-align: center; cursor: pointer;
  font-size: 13px; font-weight: 600; color: var(--primary);
}

/* ─── SETTINGS SCREEN ─── */
.settings-scroll { flex: 1; overflow-y: auto; padding: 16px; }
.settings-card {
  padding: 16px; background: var(--card); border-radius: var(--radius);
  border: 1px solid var(--border); margin-bottom: 12px; box-shadow: var(--shadow-sm);
}
.sc-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
.sc-desc { font-size: 12px; color: var(--text-sec); }
.toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.toggle {
  width: 52px; height: 28px; border-radius: 14px; padding: 2px;
  cursor: pointer; transition: all 0.2s; border: none;
}
.toggle.on { background: var(--success); }
.toggle.off { background: var(--border); }
.toggle-knob {
  width: 24px; height: 24px; border-radius: 12px; background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s;
}
.toggle.on .toggle-knob { transform: translateX(24px); }
.api-input-group { margin-top: 12px; }
.api-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.api-input {
  width: 100%; padding: 11px 14px; border-radius: var(--radius-sm);
  border: 1.5px solid var(--border); font-size: 13px; font-family: monospace;
  color: var(--text); outline: none; background: var(--bg);
}
.api-input:focus { border-color: var(--primary); }
.api-hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; line-height: 1.5; }
.api-status {
  margin-top: 10px; padding: 6px 12px; border-radius: var(--radius-full);
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 600;
}
.api-status.ready { background: var(--success-soft); color: var(--success); }

/* ─── GUIDE SCREEN ─── */
.guide-scroll { flex: 1; overflow-y: auto; padding: 16px; }
.guide-step {
  padding: 14px 16px; margin-bottom: 10px; background: var(--card);
  border-radius: var(--radius); border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.gs-row { display: flex; align-items: flex-start; gap: 12px; }
.gs-num {
  width: 28px; height: 28px; border-radius: 50%; background: var(--primary);
  color: white; display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; flex-shrink: 0;
}
.gs-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
.gs-content { font-size: 12.5px; color: var(--text-sec); line-height: 1.6; }

.validation-box {
  padding: 14px; margin-top: 8px; border-radius: var(--radius);
  background: var(--success-soft); border: 1px solid rgba(29,163,98,0.2);
}
.vb-title { font-size: 13px; font-weight: 700; color: var(--success); margin-bottom: 4px; }
.vb-content { font-size: 12px; color: var(--success); line-height: 1.6; }

/* ─── UTILITY ─── */
input[type="file"] { display: none; }
.hidden { display: none !important; }

.med-divider {
  margin: 14px 0 10px;
  padding-top: 14px;
  border-top: 2px dashed var(--border);
  font-size: 11px;
  font-weight: 700;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.result-field.warning-field {
  background: #FFFAF5;
  border-color: rgba(200, 139, 10, 0.3);
}

/* ─── EMPTY STATE ─── */
.empty-state {
  text-align: center; padding: 40px 32px; color: var(--text-muted);
}
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-title { font-size: 16px; font-weight: 700; color: var(--text-sec); margin-bottom: 4px; }
.empty-text { font-size: 13px; line-height: 1.5; }

/* ─── TOAST ─── */
.toast {
  position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px);
  left: 50%; transform: translateX(-50%) translateY(100px);
  padding: 12px 24px; border-radius: var(--radius-full);
  background: var(--text); color: white; font-size: 13px; font-weight: 600;
  box-shadow: var(--shadow-lg); z-index: 300; transition: transform 0.3s ease;
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- ─── OFFLINE INDICATOR ─── -->
<div class="offline-bar" id="offline-bar"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h.01"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/><path d="M5 12.859a10 10 0 0 1 5.17-2.69"/><path d="M19 12.859a10 10 0 0 0-2.007-1.523"/><path d="M2 8.82a15 15 0 0 1 4.177-2.643"/><path d="M22 8.82a15 15 0 0 0-11.288-3.764"/><path d="m2 2 20 20"/></svg> Offline — orders will sync when connected</div>

<!-- ═══════════ HOME SCREEN ═══════════ -->
<div id="screen-home" class="screen active">
  <div class="home-header">
    <div class="home-logo">
      <div class="home-logo-icon"><svg style="color:white" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 1.5 3 3L5.5 12.5l-3-3a4.24 4.24 0 0 1 0-6 4.24 4.24 0 0 1 6 0z"/><path d="m13.5 10.5 3 3-8 8-3-3a4.24 4.24 0 0 1 0-6 4.24 4.24 0 0 1 6 0z"/><path d="m8 2 8 8"/></svg></div>
      <div class="home-logo-text">CareOS AI</div>
      <div class="home-logo-badge">v0.2 Demo</div>
    </div>
    <div style="font-size:13px;opacity:0.7;margin-bottom:4px;">AI-Powered eMAR for Assisted Living</div>
    <div style="font-size:11px;opacity:0.5;">Photograph → AI Extracts → You Confirm → eMAR Updated</div>
    <div class="home-stats">
      <div class="home-stat">
        <div class="home-stat-value" id="stat-processed">0</div>
        <div class="home-stat-label">Processed</div>
      </div>
      <div class="home-stat">
        <div class="home-stat-value" id="stat-accuracy">—</div>
        <div class="home-stat-label">Avg Accuracy</div>
      </div>
      <div class="home-stat">
        <div class="home-stat-value" id="stat-active-meds">0</div>
        <div class="home-stat-label">Active Meds</div>
      </div>
    </div>
  </div>

  <!-- Mode indicator -->
  <div id="mode-indicator" class="mode-bar demo">
    <div class="mode-dot"></div>
    <span id="mode-text">Setup needed — add API key in Settings</span>
  </div>

  <!-- Pending orders alert -->
  <div id="pending-alert" class="pending-alert hidden" onclick="navigateTo('residents')">
    <span class="pending-alert-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg></span>
    <div class="pending-alert-text">
      <div class="pending-alert-title" id="pending-alert-title">2 medications awaiting receipt</div>
      <div class="pending-alert-sub">Tap to confirm physical delivery</div>
    </div>
    <span class="pending-alert-arrow"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></span>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <div class="section-label">Quick Actions</div>
    <div class="quick-grid">
      <div class="quick-card" onclick="navigateTo('scan')">
        <span class="quick-icon"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg></span>
        <span class="quick-label">Scan Order</span>
        <span class="quick-desc">AI reads doctor's orders from photos</span>
      </div>
      <div class="quick-card" onclick="navigateTo('residents')">
        <span class="quick-icon"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
        <span class="quick-label">Residents</span>
        <span class="quick-desc">Profiles, meds & allergies</span>
      </div>
      <div class="quick-card" onclick="navigateTo('history')">
        <span class="quick-icon"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
        <span class="quick-label">History</span>
        <span class="quick-desc">All processed orders</span>
      </div>
      <div class="quick-card" onclick="showScreen('guide')">
        <span class="quick-icon"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg></span>
        <span class="quick-label">Test Guide</span>
        <span class="quick-desc">How to validate the AI</span>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="section-header">
    <div class="section-label" style="margin-bottom:0">Recent Activity</div>
    <span class="section-link" onclick="navigateTo('history')">View All</span>
  </div>
  <div class="recent-section" id="recent-activity"></div>
</div>

<!-- ═══════════ RESIDENTS SCREEN ═══════════ -->
<div id="screen-residents" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-title">Residents</div>
    </div>
  </div>
  <div class="residents-scroll" id="residents-scroll"></div>
</div>

<!-- ═══════════ RESIDENT PROFILE SCREEN ═══════════ -->
<div id="screen-profile" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="navigateTo('residents')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg></button>
      <div class="topbar-title" id="profile-topbar-name">Resident</div>
      <button class="topbar-action" style="background:var(--primary-soft);color:var(--primary);" onclick="scanForCurrentResident()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> New Order</button>
    </div>
  </div>
  <div id="profile-header-area"></div>
  <div class="profile-scroll" id="profile-scroll"></div>
</div>

<!-- ═══════════ SCAN SCREEN ═══════════ -->
<div id="screen-scan" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-title">Scan Doctor Order</div>
    </div>
  </div>

  <!-- Resident selector -->
  <div class="resident-section">
    <div class="section-label">Processing order for</div>
    <div class="resident-chips" id="resident-chips"></div>
  </div>

  <!-- Capture -->
  <div class="capture-section">
    <div class="capture-main" id="btn-camera">
      <div class="capture-icon"><svg style="color:white" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg></div>
      <div class="capture-text">Take Photo of Doctor's Order</div>
      <div class="capture-subtext">Point your camera at the document</div>
    </div>

    <div class="capture-upload" id="btn-upload">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg>
      <span>Upload from Files</span>
    </div>

    <!-- Sample Orders -->
    <div class="sample-section" style="padding:0;">
      <div class="section-label">Try a sample order</div>
      <div class="sample-strip" id="sample-strip"></div>
    </div>

    <div class="info-box accent">
      <svg style="flex-shrink:0" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
      <div>
        <strong>How it works:</strong> AI reads the photo and extracts medication name, dosage, route, frequency, prescriber, and instructions. You always review and confirm.
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ PROCESSING SCREEN ═══════════ -->
<div id="screen-processing" class="screen no-nav">
  <div class="processing-center">
    <div class="processing-preview" id="processing-preview"></div>
    <div class="spinner"></div>
    <div class="processing-title">Reading Order...</div>
    <div class="processing-step" id="processing-step">Analyzing image...</div>
    <div class="processing-dots">
      <div class="processing-dot"></div>
      <div class="processing-dot"></div>
      <div class="processing-dot"></div>
      <div class="processing-dot"></div>
    </div>
  </div>
</div>

<!-- ═══════════ RESULTS SCREEN ═══════════ -->
<div id="screen-results" class="screen no-nav">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="navigateTo('scan')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg></button>
      <div>
        <div class="topbar-title">Review Extraction</div>
        <div class="topbar-subtitle" id="results-subtitle"></div>
      </div>
    </div>
  </div>
  <div class="results-scroll" id="results-scroll"></div>
  <div class="results-bottom">
    <div class="confirm-stats" id="confirm-stats"></div>
    <button class="btn-confirm" id="btn-confirm-order" onclick="confirmOrder()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Confirm & Add to Pending</button>
    <div class="pending-note">Medication stays PENDING until physical receipt is confirmed</div>
  </div>
</div>

<!-- ═══════════ CONFIRMED SCREEN ═══════════ -->
<div id="screen-confirmed" class="screen no-nav">
  <div class="confirmed-center">
    <div class="confirmed-check"><svg style="color:var(--success)" xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
    <div class="confirmed-title">Order Confirmed</div>
    <div class="confirmed-med" id="confirmed-med"></div>
    <div class="confirmed-resident" id="confirmed-resident"></div>
    <div class="confirmed-time-badge" id="confirmed-time"></div>
    <div class="confirmed-status">Status: PENDING — awaiting physical receipt</div>
    <button class="btn-primary" onclick="resetAndGoScan()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg> Process Another Order</button>
    <button class="btn-secondary" style="margin-bottom:10px;" onclick="viewResidentProfile(state.selectedResident)">View Resident Profile</button>
    <button class="btn-secondary" onclick="navigateTo('history')">View History (<span id="confirmed-count">0</span>)</button>
  </div>
</div>

<!-- ═══════════ HISTORY SCREEN ═══════════ -->
<div id="screen-history" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-title">Processing History</div>
    </div>
  </div>
  <div class="history-scroll" id="history-scroll"></div>
</div>

<!-- ═══════════ SETTINGS SCREEN ═══════════ -->
<div id="screen-settings" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-title">Settings</div>
    </div>
  </div>
  <div class="settings-scroll">
    <div class="settings-card">
      <div class="toggle-row">
        <div>
          <div class="sc-title"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="4" rx="2"/><rect width="6" height="6" x="9" y="9" rx="1"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></svg> Use Real Claude API</div>
          <div class="sc-desc">Connect to Anthropic's Claude Vision</div>
        </div>
        <button class="toggle off" id="toggle-api" onclick="toggleAPI()">
          <div class="toggle-knob"></div>
        </button>
      </div>
      <div id="api-config" class="hidden">
        <div class="api-input-group">
          <div class="api-label">Anthropic API Key</div>
          <input type="password" class="api-input" id="api-key-input" placeholder="sk-ant-api03-..." oninput="onApiKeyInput()">
          <div class="api-hint">Get your key at <strong>console.anthropic.com</strong>. Your key stays in your browser only — never sent anywhere except Anthropic's API.<br><br><strong>Tip:</strong> Add <code>?key=YOUR_KEY</code> to the URL to auto-load your key.</div>
          <div class="api-status ready hidden" id="api-status">
            <div class="mode-dot" style="background:var(--success);width:7px;height:7px;"></div>
            API key set — ready for live testing
          </div>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="sc-title"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg> Model Selection</div>
      <div class="sc-desc" style="margin-bottom:10px;">Choose which Claude model to use</div>
      <select id="model-select" style="width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1.5px solid var(--border);font-family:var(--font);font-size:13px;font-weight:600;background:var(--bg);color:var(--text);">
        <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Fastest/Cheapest)</option>
      </select>
    </div>

    <div class="settings-card">
      <div class="sc-title"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Estimated API Cost</div>
      <div class="sc-desc" style="line-height:1.6;">
        Each doctor order photo costs approximately <strong>$0.01–$0.03</strong> to process.
        A facility processing 10 orders/month costs roughly <strong>$0.10–$0.30/month</strong>.
      </div>
    </div>

    <div class="settings-card">
      <div class="sc-title"><svg style="color:var(--danger)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Clear All Data</div>
      <div class="sc-desc" style="margin-bottom:10px;">Remove all history and settings from this device</div>
      <button class="btn-secondary" onclick="clearAllData()" style="width:100%;color:var(--danger);border-color:var(--danger);font-size:13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Clear All Data
      </button>
    </div>

    <div class="settings-card">
      <div class="sc-title"><svg style="color:var(--primary)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg> Test Guide</div>
      <div class="sc-desc" style="margin-bottom:10px;">Step-by-step instructions for validating the AI</div>
      <button class="btn-secondary" onclick="showScreen('guide')" style="width:100%;font-size:13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg> Open Test Guide
      </button>
    </div>
  </div>
</div>

<!-- ═══════════ GUIDE SCREEN ═══════════ -->
<div id="screen-guide" class="screen">
  <div class="topbar">
    <div class="topbar-row">
      <button class="topbar-back" onclick="navigateTo('settings')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg></button>
      <div class="topbar-title">Testing Guide</div>
    </div>
  </div>
  <div class="guide-scroll">
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">1</div>
        <div>
          <div class="gs-title">Get Sample Doctor Orders</div>
          <div class="gs-content">Search Google Images for "physician medication order form" or "doctor prescription order." You can also write fake orders by hand — that's the best test. Or try the built-in sample orders on the Scan screen.</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">2</div>
        <div>
          <div class="gs-title">Set Up Your API Key</div>
          <div class="gs-content">Go to console.anthropic.com → Create account → Add credit card ($5 minimum) → API Keys → Create new key → Copy it. Then paste it in Settings.</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">3</div>
        <div>
          <div class="gs-title">Run 20–30 Test Orders</div>
          <div class="gs-content">Test a variety: printed orders, handwritten, faxed copies, multiple medications, PRN orders, discontinuations. For each one, check: Did it get the medication name right? The dosage? Did you need to edit fields?</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">4</div>
        <div>
          <div class="gs-title">Track Your Results</div>
          <div class="gs-content">The History screen tracks every order with accuracy scores. After 20+ tests, check your overall accuracy. Also check your Anthropic dashboard — total cost should be well under $1.</div>
        </div>
      </div>
    </div>
    <div class="guide-step">
      <div class="gs-row">
        <div class="gs-num">5</div>
        <div>
          <div class="gs-title">Evaluate Results</div>
          <div class="gs-content">Count how many orders had ALL fields correct without editing. Calculate: (correct orders ÷ total orders) × 100 = your accuracy rate.</div>
        </div>
      </div>
    </div>
    <div class="validation-box">
      <div class="vb-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> What "Validated" Looks Like</div>
      <div class="vb-content">90%+ accuracy on printed orders, 80%+ on handwritten, processing time under 15 seconds, and total test cost under $1. If you hit these numbers, the AI differentiator is validated.</div>
    </div>
  </div>
</div>

<!-- ═══════════ BOTTOM NAVIGATION ═══════════ -->
<div class="bottom-nav" id="bottom-nav">
  <button class="nav-item active" data-tab="home" onclick="navigateTo('home')">
    <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></span>
    <span class="nav-label">Home</span>
  </button>
  <button class="nav-item" data-tab="residents" onclick="navigateTo('residents')">
    <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
    <span class="nav-label">Residents</span>
    <span class="nav-badge hidden" id="nav-pending-badge">0</span>
  </button>
  <button class="nav-item scan-btn" data-tab="scan" onclick="navigateTo('scan')">
    <span class="nav-icon"><svg style="color:white" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg></span>
    <span class="nav-label">Scan</span>
  </button>
  <button class="nav-item" data-tab="history" onclick="navigateTo('history')">
    <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
    <span class="nav-label">History</span>
  </button>
  <button class="nav-item" data-tab="settings" onclick="navigateTo('settings')">
    <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></span>
    <span class="nav-label">Settings</span>
  </button>
</div>

<!-- File inputs -->
<input type="file" id="input-camera" accept="image/*" capture="environment">
<input type="file" id="input-upload" accept="image/*,.pdf">

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ═══════════ STATE ═══════════
let state = {
  apiKey: '',
  useRealAPI: false,
  model: 'claude-sonnet-4-20250514',
  selectedResident: 'Dorothy M.',
  currentImage: null,
  currentResults: null,
  editingField: null,
  history: [],
  medications: {}, // { residentName: [{ name, dosage, route, frequency, status, ... }] }
  processStartTime: null,
};

// ═══════════ RESIDENT DATA ═══════════
const RESIDENTS_DATA = {
  'Dorothy M.': {
    name: 'Dorothy M.', fullName: 'Dorothy Mae Henderson', dob: '03/14/1938', age: 87,
    room: 'Room 1', admitted: '09/15/2024', color: '#1B7A9E',
    physician: 'Dr. Sarah Chen', physicianPhone: '(206) 555-0142',
    pharmacy: 'Omnicare LTC Pharmacy', pharmacyPhone: '(206) 555-0200',
    emergencyContact: 'Linda Henderson (Daughter)', emergencyPhone: '(206) 555-0388',
    insurance: 'Medicare + Medicaid', allergies: ['Penicillin', 'Sulfa drugs'],
    diagnoses: ['Hypertension', 'Type 2 Diabetes', 'Osteoarthritis', 'Mild Cognitive Impairment'],
  },
  'Robert K.': {
    name: 'Robert K.', fullName: 'Robert Kenneth Park', dob: '07/22/1941', age: 84,
    room: 'Room 2', admitted: '01/08/2025', color: '#E56B3E',
    physician: 'Dr. Michael Torres', physicianPhone: '(206) 555-0156',
    pharmacy: 'PharMerica', pharmacyPhone: '(206) 555-0210',
    emergencyContact: 'James Park (Son)', emergencyPhone: '(425) 555-0291',
    insurance: 'Medicare Part D', allergies: ['Codeine'],
    diagnoses: ['COPD', 'Atrial Fibrillation', 'GERD', 'Depression'],
  },
  'Helen W.': {
    name: 'Helen W.', fullName: 'Helen Whitfield', dob: '11/30/1935', age: 90,
    room: 'Room 3', admitted: '06/22/2024', color: '#1DA362',
    physician: 'Dr. Sarah Chen', physicianPhone: '(206) 555-0142',
    pharmacy: 'Omnicare LTC Pharmacy', pharmacyPhone: '(206) 555-0200',
    emergencyContact: 'Susan Whitfield (Daughter)', emergencyPhone: '(253) 555-0145',
    insurance: 'Medicare + Supplement Plan F', allergies: [],
    diagnoses: ['Congestive Heart Failure', 'Osteoporosis', 'Hypothyroidism'],
  },
  'James T.': {
    name: 'James T.', fullName: 'James Thomas Rivera', dob: '02/05/1945', age: 81,
    room: 'Room 4', admitted: '11/01/2024', color: '#8B5CF6',
    physician: 'Dr. Anil Patel', physicianPhone: '(206) 555-0178',
    pharmacy: 'PharMerica', pharmacyPhone: '(206) 555-0210',
    emergencyContact: 'Maria Rivera (Wife)', emergencyPhone: '(206) 555-0422',
    insurance: 'VA Healthcare + Medicare', allergies: ['Aspirin', 'Ibuprofen'],
    diagnoses: ['Parkinson\'s Disease', 'Hypertension', 'BPH', 'Insomnia'],
  },
  'Patricia L.': {
    name: 'Patricia L.', fullName: 'Patricia Lynn Douglas', dob: '08/19/1940', age: 85,
    room: 'Room 5', admitted: '03/10/2025', color: '#D946A8',
    physician: 'Dr. Michael Torres', physicianPhone: '(206) 555-0156',
    pharmacy: 'Omnicare LTC Pharmacy', pharmacyPhone: '(206) 555-0200',
    emergencyContact: 'Tom Douglas (Son)', emergencyPhone: '(360) 555-0503',
    insurance: 'Medicare + Medicaid', allergies: ['Latex'],
    diagnoses: ['Alzheimer\'s Disease (moderate)', 'Anxiety Disorder', 'Urinary Incontinence'],
  },
};

const RESIDENT_NAMES = Object.keys(RESIDENTS_DATA);

const SYSTEM_PROMPT = `You are an expert medical prescription and doctor order extraction AI for an assisted living facility. You read handwritten, faxed, printed, and typed orders from photographs.

## PROCESS — follow these 3 steps:

### STEP 1: RAW READ
Read everything on the document — headers, patient info, prescriber info, every Rx line.

### STEP 2: MEDICAL INTERPRETATION
- Correct drug name misspellings (Topamex→Topamax, Lipator→Lipitor, amlodapine→Amlodipine, metforman→Metformin, gabapenten→Gabapentin, levothyroxin→Levothyroxine, omeprazol→Omeprazole, lisinipril→Lisinopril, atorvistatin→Atorvastatin)
- Decode ALL abbreviations to plain English (see reference below)
- Roman numerals for tablet counts: "IV tabs"=4 tablets, "ii caps"=2 capsules — NOT intravenous
- Chemical formulas: FeSO4=Ferrous Sulfate (Iron), KCl=Potassium Chloride, CaCO3=Calcium Carbonate, NaHCO3=Sodium Bicarbonate, MgO=Magnesium Oxide
- Short names: ASA=Aspirin, APAP=Acetaminophen, MOM=Milk of Magnesia, MVI=Multivitamin, HCTZ=Hydrochlorothiazide, NTG=Nitroglycerin, PCN=Penicillin, SMZ-TMP=Sulfamethoxazole-Trimethoprim

### STEP 3: OUTPUT structured JSON

## ABBREVIATION REFERENCE — always decode to plain English:

FREQUENCY: qd=once daily | bid=twice daily | tid=3 times daily | qid=4 times daily | prn=as needed | q4h/q6h/q8h/q12h=every 4/6/8/12 hours | qhs=at bedtime | ac=before meals | pc=after meals | A.D./ad/ud=as directed | stat=immediately | qam=every morning | qpm=every evening | qod=every other day | biw=twice weekly | tiw=3 times weekly

ROUTE: po/PO=by mouth | sl/SL=under the tongue | pr/PR=rectal | im/IM=intramuscular injection | iv/IV=intravenous | subq/sq/SC=subcutaneous injection | top=apply to skin | inh=inhaled | neb=via nebulizer | gtts=drops | OU=both eyes | OD=right eye | OS=left eye

FORM: tab/tabs=tablet(s) | cap/caps=capsule(s) | gtt/gtts=drop(s) | tsp=teaspoon 5mL | tbsp=tablespoon 15mL | susp=liquid suspension | sol=solution | ung/oint=ointment | cr=cream | supp=suppository | MDI=inhaler | patch=skin patch

QUANTITY: Sig/sig=directions | Disp/disp=dispense | #30=quantity 30 | i=1 ii=2 iii=3 iv=4 v=5 vi=6 (Roman numerals) | ss=half | aa=of each

OTHER: Rx=prescription | d/c/DC=discontinue | NKA=no known allergies | DAW=dispense as written | NR=no refill | NPO=nothing by mouth

## RULES:
1. Return ALL medications found. One form can have 1, 2, 3+ separate medications.
2. If compound formula (ingredients mixed together), set is_compound:true.
3. Every value MUST be PLAIN ENGLISH. Never return raw abbreviations. "po bid" must become "By mouth, twice daily"
4. If illegible, say "Unclear — best guess: [guess]" and set confidence low.
5. Flag safety concerns in warnings array.
6. Dates in MM/DD/YYYY.

## OUTPUT — Return ONLY this JSON, no backticks, no markdown:
{
  "medications": [
    {
      "name": "Full drug name (brand + generic if known)",
      "dosage": "Amount and unit",
      "route": "Plain English",
      "frequency": "Plain English",
      "form": "tablet, capsule, syrup, etc.",
      "instructions": "Complete plain-English directions for a caregiver",
      "quantity": "Amount dispensed if specified",
      "refills": "Number if specified",
      "prescriber": "Doctor name if visible",
      "date": "Order date if visible",
      "is_compound": false,
      "warnings": [],
      "confidence": 85
    }
  ],
  "patient_name": "If visible",
  "summary": "One plain-English sentence summarizing the entire order"
}`;

// ═══════════ INIT ═══════════
function init() {
  try {
    const saved = JSON.parse(localStorage.getItem('careos_state') || '{}');
    if (saved.apiKey) state.apiKey = saved.apiKey;
    if (saved.useRealAPI) state.useRealAPI = saved.useRealAPI;
    if (saved.model) state.model = saved.model;
    if (saved.history) state.history = saved.history;
    if (saved.medications) state.medications = saved.medications;
  } catch(e) {}

  // ─── URL PARAMETER API KEY ───
  const params = new URLSearchParams(window.location.search);
  const urlKey = params.get('key');
  if (urlKey && urlKey.startsWith('sk-')) {
    state.apiKey = urlKey;
    state.useRealAPI = true;
    saveState();
    // Clean URL so key isn't visible in browser bar / history
    if (window.history.replaceState) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  renderResidentChips();
  updateModeIndicator();
  updateStats();
  updatePendingAlert();
  renderRecentActivity();
  renderSampleOrders();

  // Settings UI
  if (state.useRealAPI) {
    document.getElementById('toggle-api').classList.replace('off','on');
    document.getElementById('api-config').classList.remove('hidden');
  }
  if (state.apiKey) {
    document.getElementById('api-key-input').value = state.apiKey;
    document.getElementById('api-status').classList.remove('hidden');
  }
  document.getElementById('model-select').value = state.model;

  // Event listeners
  document.getElementById('btn-camera').addEventListener('click', () => document.getElementById('input-camera').click());
  document.getElementById('btn-upload').addEventListener('click', () => document.getElementById('input-upload').click());
  document.getElementById('input-camera').addEventListener('change', handleImage);
  document.getElementById('input-upload').addEventListener('change', handleImage);
  document.getElementById('model-select').addEventListener('change', (e) => { state.model = e.target.value; saveState(); });

  // Offline detection
  window.addEventListener('online', () => document.getElementById('offline-bar').classList.remove('show'));
  window.addEventListener('offline', () => document.getElementById('offline-bar').classList.add('show'));
  if (!navigator.onLine) document.getElementById('offline-bar').classList.add('show');
}

function saveState() {
  localStorage.setItem('careos_state', JSON.stringify({
    apiKey: state.apiKey, useRealAPI: state.useRealAPI,
    model: state.model, history: state.history, medications: state.medications,
  }));
}

// ═══════════ NAVIGATION ═══════════
function navigateTo(tab) {
  // Map tab to screen
  const screenMap = { home: 'home', residents: 'residents', scan: 'scan', history: 'history', settings: 'settings' };
  if (screenMap[tab]) {
    showScreen(tab);
    // Update nav
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-tab="${tab}"]`);
    if (navItem) navItem.classList.add('active');
  }
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById('screen-' + id);
  screen.classList.add('active');

  // Show/hide bottom nav
  const nav = document.getElementById('bottom-nav');
  nav.style.display = screen.classList.contains('no-nav') ? 'none' : 'flex';

  if (id === 'history') renderHistory();
  if (id === 'home') { updateStats(); updatePendingAlert(); renderRecentActivity(); }
  if (id === 'residents') renderResidentsList();
  window.scrollTo(0, 0);
}

function resetAndGoScan() {
  state.currentImage = null;
  state.currentResults = null;
  state.editingField = null;
  document.getElementById('input-camera').value = '';
  document.getElementById('input-upload').value = '';
  navigateTo('scan');
}

// ═══════════ TOAST ═══════════
function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ═══════════ RESIDENTS ═══════════
function renderResidentChips() {
  const container = document.getElementById('resident-chips');
  container.innerHTML = RESIDENT_NAMES.map(name =>
    `<div class="resident-chip ${name === state.selectedResident ? 'active' : ''}" onclick="selectResident('${name}')">${name}</div>`
  ).join('');
}

function selectResident(name) {
  state.selectedResident = name;
  renderResidentChips();
}

function renderResidentsList() {
  const container = document.getElementById('residents-scroll');
  container.innerHTML = RESIDENT_NAMES.map(name => {
    const r = RESIDENTS_DATA[name];
    const meds = state.medications[name] || [];
    const activeMeds = meds.filter(m => m.status === 'active').length;
    const pendingMeds = meds.filter(m => m.status === 'pending').length;
    const hasAllergy = r.allergies.length > 0;

    return `<div class="resident-card" onclick="viewResidentProfile('${name}')">
      <div class="rc-top">
        <div class="rc-avatar" style="background:${r.color}">${name.split(' ').map(n=>n[0]).join('')}</div>
        <div class="rc-info">
          <div class="rc-name">${r.fullName}</div>
          <div class="rc-detail">${r.room} · Age ${r.age} · Dr. ${r.physician.replace('Dr. ','')}</div>
          <div class="rc-badges">
            ${activeMeds > 0 ? `<span class="rc-badge meds"><svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 1.5 3 3L5.5 12.5l-3-3a4.24 4.24 0 0 1 0-6 4.24 4.24 0 0 1 6 0z"/><path d="m13.5 10.5 3 3-8 8-3-3a4.24 4.24 0 0 1 0-6 4.24 4.24 0 0 1 6 0z"/><path d="m8 2 8 8"/></svg> ${activeMeds} active</span>` : ''}
            ${pendingMeds > 0 ? `<span class="rc-badge pending"><svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg> ${pendingMeds} pending</span>` : ''}
            ${hasAllergy ? `<span class="rc-badge allergy"><svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> Allergies</span>` : ''}
            ${!activeMeds && !pendingMeds ? `<span class="rc-badge meds">No medications yet</span>` : ''}
          </div>
        </div>
        <span class="rc-arrow"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></span>
      </div>
    </div>`;
  }).join('');
}

// ═══════════ RESIDENT PROFILE ═══════════
function viewResidentProfile(name) {
  const r = RESIDENTS_DATA[name];
  if (!r) return;
  state.selectedResident = name;

  document.getElementById('profile-topbar-name').textContent = r.name;

  // Header
  const headerArea = document.getElementById('profile-header-area');
  headerArea.innerHTML = `<div class="profile-header">
    <div class="profile-avatar" style="background:${r.color}">${name.split(' ').map(n=>n[0]).join('')}</div>
    <div class="profile-name">${r.fullName}</div>
    <div class="profile-sub">${r.room} · Age ${r.age} · Admitted ${r.admitted}</div>
    ${r.allergies.length > 0 ? `<div class="profile-allergy-bar"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg> ALLERGIES: ${r.allergies.join(', ')}</div>` : ''}
  </div>`;

  // Body
  const scroll = document.getElementById('profile-scroll');
  const meds = state.medications[name] || [];
  const activeMeds = meds.filter(m => m.status === 'active');
  const pendingMeds = meds.filter(m => m.status === 'pending');

  let html = '';

  // Pending meds (need receipt confirmation)
  if (pendingMeds.length > 0) {
    html += `<div class="profile-section" style="border-color:rgba(229,107,62,0.3);background:#FFFAF5;">
      <div class="ps-title" style="color:var(--accent)"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg> Pending Receipt (${pendingMeds.length})</div>`;
    pendingMeds.forEach((med, i) => {
      const medIdx = meds.indexOf(med);
      html += `<div class="med-list-card" style="border-color:rgba(229,107,62,0.2);">
        <div class="ml-top">
          <div>
            <div class="ml-name">${med.name}</div>
            <div class="ml-dose">${med.dosage || ''} ${med.route ? '· ' + med.route : ''}</div>
          </div>
          <span class="ml-status pending">PENDING</span>
        </div>
        <div class="ml-freq">${med.frequency || ''} ${med.prescriber ? '· ' + med.prescriber : ''}</div>
        <button class="ml-confirm-btn" onclick="event.stopPropagation(); confirmReceipt('${name}', ${medIdx})">
          ✓ Confirm Physical Receipt
        </button>
      </div>`;
    });
    html += `</div>`;
  }

  // Active meds
  html += `<div class="profile-section">
    <div class="ps-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 1.5 3 3L5.5 12.5l-3-3a4.24 4.24 0 0 1 0-6 4.24 4.24 0 0 1 6 0z"/><path d="m13.5 10.5 3 3-8 8-3-3a4.24 4.24 0 0 1 0-6 4.24 4.24 0 0 1 6 0z"/><path d="m8 2 8 8"/></svg> Active Medications (${activeMeds.length})</div>`;
  if (activeMeds.length === 0) {
    html += `<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:13px;">No active medications.<br>Scan a doctor's order to add one.</div>`;
  } else {
    activeMeds.forEach(med => {
      html += `<div class="med-list-card">
        <div class="ml-top">
          <div>
            <div class="ml-name">${med.name}</div>
            <div class="ml-dose">${med.dosage || ''} ${med.route ? '· ' + med.route : ''}</div>
          </div>
          <span class="ml-status active">ACTIVE</span>
        </div>
        <div class="ml-freq">${med.frequency || ''} ${med.form ? '· ' + med.form : ''}</div>
      </div>`;
    });
  }
  html += `</div>`;

  // Demographics
  html += `<div class="profile-section">
    <div class="ps-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Demographics</div>
    <div class="ps-row"><span class="ps-label">Full Name</span><span class="ps-value">${r.fullName}</span></div>
    <div class="ps-row"><span class="ps-label">Date of Birth</span><span class="ps-value">${r.dob}</span></div>
    <div class="ps-row"><span class="ps-label">Age</span><span class="ps-value">${r.age}</span></div>
    <div class="ps-row"><span class="ps-label">Room</span><span class="ps-value">${r.room}</span></div>
    <div class="ps-row"><span class="ps-label">Admitted</span><span class="ps-value">${r.admitted}</span></div>
    <div class="ps-row"><span class="ps-label">Insurance</span><span class="ps-value">${r.insurance}</span></div>
  </div>`;

  // Medical
  html += `<div class="profile-section">
    <div class="ps-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg> Medical Info</div>
    <div class="ps-row"><span class="ps-label">Physician</span><span class="ps-value">${r.physician}</span></div>
    <div class="ps-row"><span class="ps-label">Physician Phone</span><span class="ps-value">${r.physicianPhone}</span></div>
    <div class="ps-row"><span class="ps-label">Pharmacy</span><span class="ps-value">${r.pharmacy}</span></div>
    <div class="ps-row"><span class="ps-label">Pharmacy Phone</span><span class="ps-value">${r.pharmacyPhone}</span></div>
    <div class="ps-row"><span class="ps-label">Allergies</span><span class="ps-value" style="${r.allergies.length?'color:var(--danger);font-weight:700':''}">${r.allergies.length ? r.allergies.join(', ') : 'NKA (No Known Allergies)'}</span></div>
    <div class="ps-row"><span class="ps-label">Diagnoses</span><span class="ps-value">${r.diagnoses.join(', ')}</span></div>
  </div>`;

  // Emergency
  html += `<div class="profile-section">
    <div class="ps-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg> Emergency Contact</div>
    <div class="ps-row"><span class="ps-label">Name</span><span class="ps-value">${r.emergencyContact}</span></div>
    <div class="ps-row"><span class="ps-label">Phone</span><span class="ps-value">${r.emergencyPhone}</span></div>
  </div>`;

  scroll.innerHTML = html;
  showScreen('profile');
}

function scanForCurrentResident() {
  navigateTo('scan');
  renderResidentChips();
}

// ═══════════ RECEIPT CONFIRMATION ═══════════
function confirmReceipt(residentName, medIdx) {
  const meds = state.medications[residentName];
  if (!meds || !meds[medIdx]) return;

  if (confirm(`Confirm physical receipt of ${meds[medIdx].name} for ${residentName}?\n\nThis will move the medication to ACTIVE status on the MAR.`)) {
    meds[medIdx].status = 'active';
    meds[medIdx].activatedAt = new Date().toISOString();
    saveState();
    showToast('✓ ' + meds[medIdx].name + ' is now ACTIVE');
    viewResidentProfile(residentName);
    updatePendingAlert();
    updateNavBadge();
  }
}

// ═══════════ PENDING ALERT ═══════════
function updatePendingAlert() {
  let totalPending = 0;
  Object.values(state.medications).forEach(meds => {
    totalPending += meds.filter(m => m.status === 'pending').length;
  });
  const alert = document.getElementById('pending-alert');
  if (totalPending > 0) {
    alert.classList.remove('hidden');
    document.getElementById('pending-alert-title').textContent =
      `${totalPending} medication${totalPending > 1 ? 's' : ''} awaiting receipt`;
  } else {
    alert.classList.add('hidden');
  }
  updateNavBadge();
}

function updateNavBadge() {
  let totalPending = 0;
  Object.values(state.medications).forEach(meds => {
    totalPending += meds.filter(m => m.status === 'pending').length;
  });
  const badge = document.getElementById('nav-pending-badge');
  if (totalPending > 0) {
    badge.textContent = totalPending;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

// ═══════════ SAMPLE ORDERS ═══════════
function renderSampleOrders() {
  const samples = [
    { icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>', label: 'Handwritten Rx', desc: 'Messy handwriting test' },
    { icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>', label: 'Printed Order', desc: 'Clean typed order' },
    { icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>', label: 'Faxed Copy', desc: 'Low-quality fax' },
    { icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>', label: 'Multi-Med', desc: '3 medications' },
  ];
  document.getElementById('sample-strip').innerHTML = samples.map((s, i) =>
    `<div class="sample-card" onclick="showToast('Upload a real image to test — samples coming in v0.3')">
      <div class="sample-card-icon">${s.icon}</div>
      <div class="sample-label">${s.label}</div>
    </div>`
  ).join('');
}

// ═══════════ RECENT ACTIVITY (HOME) ─══════════
function renderRecentActivity() {
  const container = document.getElementById('recent-activity');
  if (state.history.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">
      No activity yet. Scan your first doctor's order to get started.
    </div>`;
    return;
  }
  const recent = state.history.slice(0, 3);
  container.innerHTML = recent.map(h => {
    const r = RESIDENTS_DATA[h.resident];
    const color = r ? r.color : '#8697AB';
    const initials = h.resident.split(' ').map(n=>n[0]).join('');
    const timeAgo = getTimeAgo(h.timestamp);
    return `<div class="recent-card">
      <div class="recent-avatar" style="background:${color}">${initials}</div>
      <div class="recent-info">
        <div class="recent-name">${h.medication}</div>
        <div class="recent-detail">${h.resident} · ${h.medCount > 1 ? h.medCount + ' meds' : 'Confidence: ' + h.avgConfidence + '%'}</div>
      </div>
      <div class="recent-meta">${timeAgo}</div>
    </div>`;
  }).join('');
}

function getTimeAgo(ts) {
  const diff = Date.now() - new Date(ts).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs / 24) + 'd ago';
}

// ═══════════ MODE / STATS ═══════════
function updateModeIndicator() {
  const el = document.getElementById('mode-indicator');
  const txt = document.getElementById('mode-text');
  if (state.useRealAPI && state.apiKey) {
    el.className = 'mode-bar live';
    txt.textContent = 'LIVE MODE — Connected to Claude API';
  } else {
    el.className = 'mode-bar demo';
    txt.textContent = 'Setup needed — add API key in Settings';
  }
}

function updateStats() {
  document.getElementById('stat-processed').textContent = state.history.length;
  if (state.history.length > 0) {
    const avg = Math.round(state.history.reduce((s,h) => s + h.avgConfidence, 0) / state.history.length);
    document.getElementById('stat-accuracy').textContent = avg + '%';
  } else {
    document.getElementById('stat-accuracy').textContent = '—';
  }
  // Count active meds
  let totalActive = 0;
  Object.values(state.medications).forEach(meds => {
    totalActive += meds.filter(m => m.status === 'active').length;
  });
  document.getElementById('stat-active-meds').textContent = totalActive;
}

// ═══════════ SETTINGS ═══════════
function toggleAPI() {
  state.useRealAPI = !state.useRealAPI;
  const btn = document.getElementById('toggle-api');
  const config = document.getElementById('api-config');
  btn.classList.toggle('on'); btn.classList.toggle('off');
  if (state.useRealAPI) { config.classList.remove('hidden'); } else { config.classList.add('hidden'); }
  saveState(); updateModeIndicator();
}

function onApiKeyInput() {
  state.apiKey = document.getElementById('api-key-input').value.trim();
  const status = document.getElementById('api-status');
  if (state.apiKey.length > 10) { status.classList.remove('hidden'); } else { status.classList.add('hidden'); }
  saveState(); updateModeIndicator();
}

function clearAllData() {
  if (confirm('Clear all history, medications, and settings?')) {
    state.history = [];
    state.medications = {};
    state.apiKey = '';
    state.useRealAPI = false;
    localStorage.removeItem('careos_state');
    document.getElementById('api-key-input').value = '';
    document.getElementById('api-status').classList.add('hidden');
    document.getElementById('toggle-api').classList.replace('on','off');
    document.getElementById('api-config').classList.add('hidden');
    updateStats(); updateModeIndicator(); updatePendingAlert();
    showToast('All data cleared');
  }
}

// ═══════════ IMAGE HANDLING ═══════════
function handleImage(e) {
  const file = e.target.files?.[0];
  if (!file) return;

  state.processStartTime = Date.now();
  showScreen('processing');
  document.getElementById('processing-step').textContent = 'Preparing image...';

  compressImage(file, 4.5 * 1024 * 1024).then(dataUrl => {
    state.currentImage = dataUrl;
    const preview = document.getElementById('processing-preview');
    preview.innerHTML = `<img src="${state.currentImage}" alt="Order">`;
    processOrder();
  }).catch(err => {
    alert('Error processing image: ' + err.message);
    navigateTo('scan');
  });
}

function compressImage(file, maxBytes) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        let quality = 0.85;
        let maxDim = 2400;
        function tryCompress() {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          const bytes = dataUrl.split(',')[1].length * 0.75;
          if (bytes > maxBytes && quality > 0.3) {
            quality -= 0.15;
            if (quality < 0.5) maxDim = Math.round(maxDim * 0.75);
            tryCompress();
          } else { resolve(dataUrl); }
        }
        tryCompress();
      };
      img.onerror = () => reject(new Error('Could not load image'));
      img.src = ev.target.result;
    };
    reader.onerror = () => reject(new Error('Could not read file'));
    reader.readAsDataURL(file);
  });
}

// ═══════════ PROCESS ORDER ═══════════
async function processOrder() {
  const stepEl = document.getElementById('processing-step');

  if (!state.useRealAPI || !state.apiKey) {
    alert('Please add your API key in Settings first.');
    navigateTo('settings');
    return;
  }

  try {
    stepEl.textContent = 'Connecting to Claude API...';
    await sleep(400);

    stepEl.textContent = 'Sending image for analysis...';
    const base64 = state.currentImage.split(',')[1];
    const mediaType = state.currentImage.split(';')[0].split(':')[1] || 'image/jpeg';

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: state.model, max_tokens: 4096, system: SYSTEM_PROMPT,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
            { type: 'text', text: 'Read this doctor\'s order or prescription. Extract every medication. Decode all abbreviations into plain English. Return the JSON.' }
          ]
        }]
      })
    });

    stepEl.textContent = 'Reading AI response...';
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || 'API error: ' + response.status);
    }

    const data = await response.json();
    const text = data.content?.[0]?.text || '';
    stepEl.textContent = 'Parsing results...';
    await sleep(300);

    const jsonStr = text.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    let parsed = JSON.parse(jsonStr);

    // Two-pass verification for low confidence
    const lowConf = parsed.medications?.some(m => (m.confidence || 100) < 55);
    if (lowConf) {
      stepEl.textContent = 'Double-checking unclear fields...';
      try {
        const verifyRes = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
          },
          body: JSON.stringify({
            model: state.model, max_tokens: 2048,
            messages: [{
              role: 'user',
              content: [
                { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
                { type: 'text', text: 'First read returned: ' + JSON.stringify(parsed.medications) + '\n\nSome had low confidence. Look again carefully. Return the same JSON structure with corrections.' }
              ]
            }]
          })
        });
        if (verifyRes.ok) {
          const vData = await verifyRes.json();
          const vText = vData.content?.[0]?.text || '';
          try {
            const vParsed = JSON.parse(vText.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim());
            if (vParsed.medications) parsed.medications = vParsed.medications;
            else if (Array.isArray(vParsed)) parsed.medications = vParsed;
          } catch(e) {}
        }
      } catch(e) {}
    }

    // Build fields
    const meds = parsed.medications || [];
    const fields = [];

    meds.forEach((med, idx) => {
      const p = meds.length > 1 ? '(' + (idx+1) + ' of ' + meds.length + ') ' : '';
      const c = med.confidence || 80;

      if (med.name) fields.push({key:'medication_'+idx, label:p+'Medication', value:med.name, confidence:c, edited:false});
      if (med.dosage && med.dosage !== 'Not specified') fields.push({key:'dosage_'+idx, label:p+'Dosage', value:med.dosage, confidence:c, edited:false});
      if (med.route && med.route !== 'Not specified') fields.push({key:'route_'+idx, label:p+'Route', value:med.route, confidence:Math.min(c+5,99), edited:false});
      if (med.frequency && med.frequency !== 'Not specified') fields.push({key:'frequency_'+idx, label:p+'Frequency', value:med.frequency, confidence:c, edited:false});
      if (med.form && med.form !== 'Not specified') fields.push({key:'form_'+idx, label:p+'Form', value:med.form, confidence:c, edited:false});
      if (med.prescriber && med.prescriber !== 'Not specified') fields.push({key:'prescriber_'+idx, label:p+'Prescriber', value:med.prescriber, confidence:90, edited:false});
      if (med.date && med.date !== 'Not specified') fields.push({key:'date_'+idx, label:p+'Date', value:med.date, confidence:85, edited:false});
      if (med.instructions && med.instructions !== 'Not specified') fields.push({key:'instructions_'+idx, label:p+'Directions', value:med.instructions, confidence:c, edited:false});
      if (med.quantity && med.quantity !== 'Not specified') fields.push({key:'quantity_'+idx, label:p+'Quantity', value:med.quantity, confidence:88, edited:false});
      if (med.refills && med.refills !== 'Not specified') fields.push({key:'refills_'+idx, label:p+'Refills', value:String(med.refills), confidence:90, edited:false});
      if (med.warnings && med.warnings.length > 0) {
        fields.push({key:'warnings_'+idx, label:p+'⚠ Needs Review', value:med.warnings.join('. '), confidence:45, edited:false, isWarning:true});
      }
    });

    state.currentResults = {
      summary: parsed.summary || '',
      medCount: meds.length,
      patient: parsed.patient_name || '',
      fields: fields,
      rawMeds: meds,
      isLive: true,
    };

    showScreen('results');
    renderResults();

  } catch(err) {
    alert('API Error: ' + err.message);
    navigateTo('scan');
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ═══════════ DUPLICATE CHECK ═══════════
function checkDuplicates(medName, residentName) {
  const existingMeds = state.medications[residentName] || [];
  const normalizedNew = medName.toLowerCase().replace(/[^a-z]/g, '');
  const duplicates = [];
  existingMeds.forEach(m => {
    const normalizedExisting = m.name.toLowerCase().replace(/[^a-z]/g, '');
    // Check for same drug name (fuzzy)
    if (normalizedNew.includes(normalizedExisting.slice(0,5)) ||
        normalizedExisting.includes(normalizedNew.slice(0,5)) ||
        normalizedNew === normalizedExisting) {
      duplicates.push(m);
    }
  });
  return duplicates;
}

// ═══════════ ALLERGY CHECK ═══════════
function checkAllergies(medName, residentName) {
  const r = RESIDENTS_DATA[residentName];
  if (!r || !r.allergies.length) return [];
  const normalizedMed = medName.toLowerCase();
  const matches = [];
  // Common drug-allergy mappings
  const allergyDrugMap = {
    'penicillin': ['amoxicillin', 'ampicillin', 'penicillin', 'augmentin', 'piperacillin'],
    'sulfa drugs': ['sulfamethoxazole', 'trimethoprim', 'bactrim', 'septra', 'sulfasalazine'],
    'aspirin': ['aspirin', 'asa', 'acetylsalicylic'],
    'ibuprofen': ['ibuprofen', 'advil', 'motrin', 'naproxen', 'nsaid'],
    'codeine': ['codeine', 'tylenol #3', 'tylenol #4'],
    'latex': [],
  };

  r.allergies.forEach(allergy => {
    const relatedDrugs = allergyDrugMap[allergy.toLowerCase()] || [allergy.toLowerCase()];
    relatedDrugs.forEach(drug => {
      if (normalizedMed.includes(drug)) {
        matches.push(allergy);
      }
    });
  });
  return [...new Set(matches)];
}

// ═══════════ RENDER RESULTS ═══════════
function renderResults() {
  const r = state.currentResults;
  const resident = RESIDENTS_DATA[state.selectedResident];

  document.getElementById('results-subtitle').textContent =
    'For ' + state.selectedResident + (r.patient ? ' · Patient: ' + r.patient : '') + ' · Live API';

  const scroll = document.getElementById('results-scroll');
  let html = '';

  // Banner
  const bannerText = r.medCount > 1 ? r.medCount + ' Medications Found' : 'Extraction Complete';
  html += '<div class="result-banner success">' +
    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' +
    '<div><div class="rb-text" style="color:var(--success)">' + bannerText + '</div>' +
    '<div class="rb-sub" style="color:var(--success)">' + r.summary + ' · Tap any field to edit</div></div></div>';

  // Allergy check
  if (resident && resident.allergies.length > 0) {
    const allergyMatches = [];
    (r.rawMeds || []).forEach(med => {
      const matches = checkAllergies(med.name, state.selectedResident);
      if (matches.length) allergyMatches.push({ med: med.name, allergies: matches });
    });
    if (allergyMatches.length > 0) {
      html += `<div class="dup-warning" style="background:var(--danger-soft);border-color:rgba(192,57,43,0.25);">
        <span class="dup-warning-icon"><svg style="color:var(--danger)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg></span>
        <div class="dup-warning-text" style="color:var(--danger);">
          <div class="dup-warning-title">ALLERGY ALERT</div>
          ${allergyMatches.map(a => `<strong>${a.med}</strong> may conflict with known allergy: <strong>${a.allergies.join(', ')}</strong>`).join('<br>')}
          <br>Verify with prescriber before confirming.
        </div>
      </div>`;
    }
  }

  // Duplicate check
  const dupWarnings = [];
  (r.rawMeds || []).forEach(med => {
    const dups = checkDuplicates(med.name, state.selectedResident);
    if (dups.length > 0) {
      dupWarnings.push({ newMed: med.name, existing: dups });
    }
  });
  if (dupWarnings.length > 0) {
    html += `<div class="dup-warning">
      <span class="dup-warning-icon"><svg style="color:var(--warning)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg></span>
      <div class="dup-warning-text">
        <div class="dup-warning-title">Possible Duplicate Detected</div>
        ${dupWarnings.map(d =>
          `${state.selectedResident} already has <strong>${d.existing[0].name}</strong> (${d.existing[0].status}). Is "<strong>${d.newMed}</strong>" a dosage change or duplicate?`
        ).join('<br>')}
      </div>
    </div>`;
  }

  // Image preview
  if (state.currentImage) {
    html += '<div class="result-preview"><img src="' + state.currentImage + '" alt="Order"></div>';
  }

  // Fields with medication dividers
  let currentMedIdx = -1;
  r.fields.forEach((f, i) => {
    const match = f.key.match(/_(\d+)$/);
    const medIdx = match ? parseInt(match[1]) : 0;
    if (r.medCount > 1 && medIdx !== currentMedIdx && medIdx > 0 && f.key.startsWith('medication_')) {
      html += '<div class="med-divider">Medication ' + (medIdx + 1) + '</div>';
    }
    if (f.key.startsWith('medication_')) currentMedIdx = medIdx;

    const confClass = f.confidence >= 90 ? 'conf-high' : f.confidence >= 75 ? 'conf-mid' : 'conf-low';
    const fieldClass = f.isWarning ? 'result-field warning-field' : f.edited ? 'result-field edited' : 'result-field';

    html += '<div class="' + fieldClass + '" id="field-' + i + '" onclick="startEdit(' + i + ')">' +
      '<div class="result-field-top"><div>' +
      '<span class="result-field-label">' + f.label + '</span>' +
      (f.edited ? '<span class="edited-tag">EDITED</span>' : '') +
      '</div><span class="confidence-badge ' + confClass + '">' + f.confidence + '%</span></div>' +
      '<div class="result-field-value"' + (f.isWarning ? ' style="color:var(--warning)"' : '') + '>' + f.value + '</div>' +
      (f.confidence < 75 && !f.edited && !f.isWarning ? '<div class="low-conf-warning"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> Low confidence — please verify</div>' : '') +
      '</div>';
  });

  scroll.innerHTML = html;
  updateConfirmStats();
}

function startEdit(idx) {
  if (state.editingField !== null) return;
  state.editingField = idx;
  const field = state.currentResults.fields[idx];
  const el = document.getElementById('field-' + idx);
  const valueEl = el.querySelector('.result-field-value');
  const warnEl = el.querySelector('.low-conf-warning');
  if (warnEl) warnEl.style.display = 'none';

  valueEl.innerHTML = `<div class="edit-row">
    <input class="edit-input" id="edit-input" value="${field.value.replace(/"/g,'&quot;')}" autofocus>
    <button class="edit-save" onclick="event.stopPropagation(); saveEdit(${idx})">Save</button>
    <button class="edit-cancel" onclick="event.stopPropagation(); cancelEdit()">✕</button>
  </div>`;

  setTimeout(() => document.getElementById('edit-input')?.focus(), 50);
}

function saveEdit(idx) {
  const input = document.getElementById('edit-input');
  if (input && input.value.trim()) {
    state.currentResults.fields[idx].value = input.value.trim();
    state.currentResults.fields[idx].edited = true;
    state.currentResults.fields[idx].confidence = 100;
  }
  state.editingField = null;
  renderResults();
}

function cancelEdit() {
  state.editingField = null;
  renderResults();
}

function updateConfirmStats() {
  const fields = state.currentResults.fields;
  const avg = Math.round(fields.reduce((s,f) => s + f.confidence, 0) / fields.length);
  const edited = fields.filter(f => f.edited).length;
  document.getElementById('confirm-stats').textContent =
    `Avg confidence: ${avg}% · ${edited} field${edited !== 1 ? 's' : ''} edited`;
}

// ═══════════ CONFIRM ORDER ═══════════
function confirmOrder() {
  const r = state.currentResults;
  const elapsed = Math.round((Date.now() - state.processStartTime) / 1000);

  // Add medications to resident's med list
  const residentName = state.selectedResident;
  if (!state.medications[residentName]) state.medications[residentName] = [];

  (r.rawMeds || []).forEach((med, idx) => {
    // Get potentially edited values
    const getName = r.fields.find(f => f.key === 'medication_' + idx)?.value || med.name;
    const getDosage = r.fields.find(f => f.key === 'dosage_' + idx)?.value || med.dosage;
    const getRoute = r.fields.find(f => f.key === 'route_' + idx)?.value || med.route;
    const getFrequency = r.fields.find(f => f.key === 'frequency_' + idx)?.value || med.frequency;
    const getForm = r.fields.find(f => f.key === 'form_' + idx)?.value || med.form;
    const getPrescriber = r.fields.find(f => f.key === 'prescriber_' + idx)?.value || med.prescriber;

    state.medications[residentName].push({
      name: getName, dosage: getDosage, route: getRoute,
      frequency: getFrequency, form: getForm, prescriber: getPrescriber,
      status: 'pending', addedAt: new Date().toISOString(),
    });
  });

  // History entry
  const entry = {
    timestamp: new Date().toISOString(),
    displayTime: new Date().toLocaleString(),
    resident: residentName,
    medication: r.fields.filter(f => f.key.startsWith('medication_')).map(f => f.value).join(' + ') || 'Unknown',
    medCount: r.medCount || 1,
    summary: r.summary,
    fieldsEdited: r.fields.filter(f => f.edited).length,
    totalFields: r.fields.length,
    avgConfidence: Math.round(r.fields.reduce((s,f) => s + f.confidence, 0) / r.fields.length),
    isLive: r.isLive,
    processingTime: elapsed,
    allFields: r.fields.map(f => ({ key: f.key, value: f.value, confidence: f.confidence, edited: f.edited })),
  };

  state.history.unshift(entry);
  saveState();

  // Update confirmed screen
  document.getElementById('confirmed-med').textContent = entry.medication;
  document.getElementById('confirmed-resident').textContent = 'For ' + entry.resident + (entry.medCount > 1 ? ' · ' + entry.medCount + ' medications' : '');
  document.getElementById('confirmed-time').textContent = `${elapsed}s processing`;
  document.getElementById('confirmed-count').textContent = state.history.length;

  showScreen('confirmed');
}

// ═══════════ RENDER HISTORY ═══════════
function renderHistory() {
  const container = document.getElementById('history-scroll');
  if (state.history.length === 0) {
    container.innerHTML = `<div class="history-empty">
      <div class="history-empty-icon"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg></div>
      <div style="font-size:15px;font-weight:600;">No orders processed yet</div>
      <div style="font-size:13px;margin-top:4px;">Take a photo of a doctor's order to get started</div>
    </div>`;
    return;
  }

  let html = `<div class="export-btn" onclick="exportHistory()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Export History as CSV</div>`;

  html += state.history.map((h, i) => {
    const accColor = h.avgConfidence >= 90 ? 'var(--success)' : h.avgConfidence >= 75 ? 'var(--warning)' : 'var(--danger)';
    return `<div class="history-card">
      <div class="hc-top">
        <div>
          <div class="hc-med">${h.medication}</div>
          <div class="hc-dose">${h.resident}${h.medCount > 1 ? ' · ' + h.medCount + ' meds' : ''}</div>
        </div>
        <span class="hc-badge ${h.isLive ? 'hc-live' : 'hc-demo'}">${h.isLive ? 'LIVE' : 'DEMO'}</span>
      </div>
      <div class="hc-accuracy">
        <div class="hc-accuracy-bar">
          <div class="hc-accuracy-fill" style="width:${h.avgConfidence}%;background:${accColor}"></div>
        </div>
        <div class="hc-accuracy-text" style="color:${accColor}">${h.avgConfidence}%</div>
      </div>
      <div class="hc-meta">
        <span>⏱ ${h.processingTime}s</span>
        <span>✏️ ${h.fieldsEdited}/${h.totalFields} edited</span>
        <span>${h.displayTime}</span>
      </div>
    </div>`;
  }).join('');

  container.innerHTML = html;
}

// ═══════════ EXPORT ═══════════
function exportHistory() {
  if (state.history.length === 0) return;
  let csv = 'Timestamp,Resident,Medication,Meds Count,Avg Confidence,Fields Edited,Total Fields,Processing Time (s),Mode\n';
  state.history.forEach(h => {
    csv += `"${h.displayTime}","${h.resident}","${h.medication}",${h.medCount},${h.avgConfidence}%,${h.fieldsEdited},${h.totalFields},${h.processingTime},${h.isLive ? 'Live' : 'Demo'}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'careos_history_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click(); URL.revokeObjectURL(url);
  showToast('CSV downloaded');
}

// ═══════════ START ═══════════
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
